DO $$DECLARE 
   r record;
   staticgeo GEOMETRY;
   patchgeo  GEOMETRY;
   step1geo  GEOMETRY;
   step2geo  GEOMETRY;
   int_srid  INTEGER := 5070;
   int_count INTEGER;
   
BEGIN
   /* Remove Overlaps - vals are (keep,clip) */
   FOR r IN SELECT * FROM (VALUES  
       (60001300061035,24001301148651)
      ,(24001301052603,60001300057667)
      ,(60001300057588,24001301530654)
      ,(60001300057921,24001301530653)
      ,(60001300055701,24001300094279)
      ,(24001300861219,60001300060287)
      ,(24001301245516,60001300060100)
      ,(60001300057025,24001301053307)
      ,(60001300058294,24001300286347)
      ,(24001301149669,60001300058016)
      ,(60001300058899,24001301053475)
      ,(24001301245836,60001300056854)
      ,(24001300573427,60001300056854)
      ,(24001300573427,60001300056877)
      ,(60001300056827,24001301053797)
      ,(24001301053797,60001300054526)
      ,(60001300056777,24001300477292)
      ,(24001300190979,60001300054528)
      ,(60001300054523,24001300190979)
      ,(24001300190979,60001300054509)
      ,(60001300056757,24001301341657)
      ,(24001301341657,60001300056750)
      ,(24001301150468,60001300012650)
      ,(60001300014372,24001301150468)
      ,(24001000087784,60001300010068)
      ,(60001300010068,24001000075321)
      ,(24001000037379,60001300010068)
      ,(60001300016531,24001000087786)
      ,(60001300026699,24001000087786)
      ,(24001000012323,60001300026699)
      ,(24001000012323,60001300003504)
      ,(60001300026813,24001000012323)
      ,(22000700071952,22000300053492)
      ,(70000100282701,70000100255835)  
   ) AS t(keep,clip)
   LOOP
      IF r.keep = r.clip
      OR r.keep IS NULL
      OR r.clip IS NULL
      THEN
         RAISE EXCEPTION 'QA problem % %',r.keep,r.clip;
      
      END IF;
      
      SELECT 
      cipsrv_nhdplus_h.snap_to_common_grid(ST_TRANSFORM(b.shape,int_srid),int_srid::VARCHAR,0.001)
      INTO
      step1geo
      FROM (
         SELECT
          aa.nhdplusid
         ,aa.shape
         FROM
         cipsrv_nhdplus_h.nhdpluscatchment aa
         UNION ALL
         SELECT
          bb.nhdplusid
         ,bb.shape
         FROM
         cipsrv_epageofab_h.grid0catchment bb
      ) b 
      WHERE 
      b.nhdplusid = r.keep;
      
      IF step1geo IS NULL
      OR ST_ISEMPTY(step1geo)
      OR ST_SRID(step1geo) = 0
      THEN
         RAISE EXCEPTION '% %',r.keep,r.clip;
         
      END IF;
      
      UPDATE cipsrv_nhdplus_h.nhdpluscatchment a
      SET shape = ST_TRANSFORM(ST_DIFFERENCE(
          cipsrv_nhdplus_h.snap_to_common_grid(ST_TRANSFORM(a.shape,int_srid),int_srid::VARCHAR,0.001)
         ,step1geo
      ),4269)
      WHERE 
      a.nhdplusid = r.clip;
      
      GET DIAGNOSTICS int_count = ROW_COUNT;

      IF int_count != 1
      THEN
         RAISE EXCEPTION 'error finding % in nhdpluscatchment',r.keep;

      END IF;         
      
      UPDATE cipsrv_nhdplus_h.nhdpluscatchment a
      SET areasqkm = ST_AREA(ST_TRANSFORM(a.shape,int_srid))::NUMERIC / 1000000
      WHERE 
      a.nhdplusid = r.clip;
        
   END LOOP;
   
   /* Remove Gaps - vals are (expand,static,patch,size)*/
   FOR r IN SELECT * FROM (VALUES
       (10000600070268,ARRAY[10000400000024],ST_POINT(-76.07702819,39.54581348,4269),30)
      ,(10000100061083,ARRAY[10000100122096],ST_POINT(-73.80735937,40.64914423,4269),15)
      ,(10000100011340,ARRAY[10000100085763,10000800096152],ST_POINT(-71.8982641,41.33582685,4269),40)
      ,(10000800051598,ARRAY[10000100074321,10000100045549],ST_POINT(-71.91973,41.34421108,4269),35)
      ,(10000100068464,ARRAY[10000800051596,10000100074321,10000100057087,10000800007867,10000800060022],ST_POINT(-71.92197864,41.34256205,4269),25)
      ,(10000800025360,ARRAY[10000100057083],ST_POINT(-71.92742204,41.33395972,4269),15)
      ,(10000800008321,ARRAY[10000100085768,10000100045559,10000100039799,10000100062689,10000800008320],ST_POINT(-71.8743426,41.33917212,4269),15)
      ,(10000100045560,ARRAY[10000800025844,10000800052045,10000100080039,10000100074329],ST_POINT(-71.87099587,41.33806238,4269),15)
      ,(10000100045560,ARRAY[10000800025844,10000100074329],ST_POINT(-71.87129166,41.33793614,4269),15)
      ,(10000100022512,ARRAY[10000800065504,10000800022055,10000800004659,10000800013386,10000100074139],ST_POINT(-72.5445302,41.2528548,4269),60)
      ,(10000100074139,ARRAY[10000100022512,10000800072836,10000800039814,10000800030971,10000800048366,10000800030970,10000800022117,10000800048366],ST_POINT(-72.53780819,41.25371163,4269),110)
      ,(10000800065175,ARRAY[10000100068247,10000100011115,10000800065177,10000800021769,10000800013071,10000800065178,10000800039490,10000800030614,10000100068246],ST_POINT(-72.68128631,41.26120512,4269),110)
      ,(10000800064652,ARRAY[10000100073961],ST_POINT(-72.93116449,41.26294565,4269),15)
      ,(10000100010986,ARRAY[10000800029789,10000800003566],ST_POINT(-73.04883356,41.21038493,4269),15)
      ,(10000800055749,ARRAY[10000100091150,10000800064254],ST_POINT(-73.06099844,41.208242,4269),60)
      ,(10000100056723,ARRAY[10000800029549,10000100091141,10000100091143,10000100005286,10000800046968],ST_POINT(-73.11021184,41.19097035,4269),15)
      ,(10000100056678,ARRAY[10000800069571,10000100010927,10000100056677,10000100091105,10000100027905],ST_POINT(-73.12082505,41.18693186,4269),15)
      ,(10000100091150,ARRAY[10000800003499],ST_POINT(-73.06160812,41.20434485,4269),15)
      ,(10000100051072,ARRAY[10000800012663],ST_POINT(-72.88441798,41.24487387,4269),15)
      ,(10000800056189,ARRAY[10000100051072,10000800030157,10000800047623,10000800047624,10000800056191,10000800047621,10000800047619],ST_POINT(-72.89121502,41.24523443,4269),60)
      ,(24001301530653,ARRAY[60001300060681,24001300764823,24001300476174,60001300056544],ST_POINT(-85.01842168,40.6792862,4269),15)
      ,(24001300669899,ARRAY[60001300056719,60001300022856],ST_POINT(-84.79620171,40.59730243,4269),15)
      ,(60001300003381,ARRAY[24001300382182],ST_POINT(-84.68417176,40.59252428,4269),15)
      ,(60001300024990,ARRAY[24001300382182,60001300003381],ST_POINT(-84.68282993,40.59267506,4269),25)
      ,(24001300382182,ARRAY[60001300003381,60001300024990],ST_POINT(-84.6836241,40.5926558,4269),40)
      ,(60001300024990,ARRAY[24001300382182,60001300003381],ST_POINT(-84.68126085,40.59263439,4269),55)
      ,(60001300003381,ARRAY[24001300477735],ST_POINT(-84.68689421,40.59870913,4269),15)
      ,(60001300008296,ARRAY[24001301054265,60001300020161],ST_POINT(-84.46569549,40.55984271,4269),25)
      ,(24001000075321,ARRAY[60001300010068],ST_POINT(-83.97061185,40.61037187,4269),15)
      ,(24001000075321,ARRAY[60001300010068],ST_POINT(-83.96985811,40.61056754,4269),15)
      ,(24001000075321,ARRAY[60001300010068],ST_POINT(-83.96960318,40.61063919,4269),15)
      ,(60001300010068,ARRAY[24001000075321],ST_POINT(-83.96855731,40.61116282,4269),15)
      ,(24001000075321,ARRAY[60001300010068],ST_POINT(-83.96690513,40.61173054,4269),15)
      ,(60001300010068,ARRAY[24001000075321],ST_POINT(-83.96556713,40.61249669,4269),15)
      ,(60001300010068,ARRAY[24001000075321],ST_POINT(-83.96531772,40.61256559,4269),15)
      ,(60001300010068,ARRAY[24001000075321],ST_POINT(-83.96557126,40.61250358,4269),15)
      ,(60001300010068,ARRAY[24001000075321],ST_POINT(-83.96531634,40.6125711,4269),15)
      ,(24001000087786,ARRAY[60001300016531],ST_POINT(-83.96112044,40.61990462,4269),25)
      ,(24001000087786,ARRAY[60001300026699],ST_POINT(-83.95892981,40.62257959,4269),15)
      ,(60001300003504,ARRAY[24001000012323],ST_POINT(-83.95946964,40.62856926,4269),15)
      ,(60001300026813,ARRAY[24001000012323,60001300003504],ST_POINT(-83.95731433,40.63457003,4269),25)
      ,(24001000012323,ARRAY[60001300026813],ST_POINT(-83.95640359,40.63530207,4269),15)
      ,(24001000012323,ARRAY[60001300026813],ST_POINT(-83.95614737,40.63536666,4269),15)
      ,(24001000012323,ARRAY[60001300031590],ST_POINT(-83.94940921,40.64110607,4269),15)
      ,(24001000012323,ARRAY[60001300031590],ST_POINT(-83.9491468,40.64117672,4269),15)
      ,(60001300031590,ARRAY[24001000012323],ST_POINT(-83.94795253,40.64115317,4269),15)
      ,(60001300031590,ARRAY[24001000012323],ST_POINT(-83.94772713,40.64104551,4269),15)
      ,(60001300031590,ARRAY[24001000012323],ST_POINT(-83.94749836,40.64092777,4269),15)
      ,(24001000012323,ARRAY[60001300031590],ST_POINT(-83.94696682,40.64051734,4269),15)
      ,(24001000012323,ARRAY[60001300031590],ST_POINT(-83.94697692,40.63980077,4269),15)
      ,(24001000012323,ARRAY[60001300031590],ST_POINT(-83.94545524,40.63956299,4269),15)
      ,(24001000012323,ARRAY[60001300031590],ST_POINT(-83.94520548,40.63963189,4269),15)
      ,(24001000012323,ARRAY[60001300031590],ST_POINT(-83.94484592,40.63968356,4269),30)
      ,(22000300063696,ARRAY[22000200009471,22000200040459,22000200034162],ST_POINT(-91.42000781,40.37757307,4269),60)
      ,(22000700086148,ARRAY[22000300086448,22000700014270],ST_POINT(-91.21955236,40.47644656,4269),15)
      ,(22000700014270,ARRAY[22000300086448],ST_POINT(-91.21719656,40.47778973,4269),15)
      ,(22000700014270,ARRAY[22000300086448],ST_POINT(-91.21682589,40.47795509,4269),15)
      ,(22000700014270,ARRAY[22000300086448],ST_POINT(-91.2162623,40.47842635,4269),30)
      ,(22000700014270,ARRAY[22000300086448],ST_POINT(-91.21595226,40.47854761,4269),15)
      ,(22000700014270,ARRAY[22000300086448],ST_POINT(-91.21571112,40.47862753,4269),15)
      ,(22000700014270,ARRAY[22000300086448],ST_POINT(-91.21546584,40.47870057,4269),15)
      ,(22000700014270,ARRAY[22000300086448],ST_POINT(-91.21485953,40.47894998,4269),40)
      ,(22000700014270,ARRAY[22000300086448],ST_POINT(-91.21437725,40.47901888,4269),15)
      ,(22000300041912,ARRAY[22000700086085,22000300052980],ST_POINT(-91.21694284,40.51880602,4269),15)
      ,(22000300086982,ARRAY[22000300086909,22000700100830],ST_POINT(-91.07707432,40.62492553,4269),15)
      ,(22000700086449,ARRAY[22000300020561,22000700057760],ST_POINT(-90.93567884,40.64420945,4269),15)
      ,(22000700072226,ARRAY[22000300065229,22000300076442],ST_POINT(-90.89913748,40.66903178,4269),15)
      ,(22000300032303,ARRAY[22000700043963,22000300032153],ST_POINT(-90.73666463,40.68524322,4269),20)
      ,(22000700001057,ARRAY[22000300000063],ST_POINT(-90.6654884,40.83434636,4269),15)
      ,(22000300000063,ARRAY[22000700001057],ST_POINT(-90.66276342,40.83556956,4269),15)
      ,(22000700001057,ARRAY[22000300000063],ST_POINT(-90.66224102,40.8360853,4269),15)
      ,(22000700001057,ARRAY[22000300000063],ST_POINT(-90.66211208,40.83625869,4269),15)
      ,(22000700001057,ARRAY[22000300000063],ST_POINT(-90.66197426,40.83644098,4269),15)
      ,(22000700001057,ARRAY[22000300000063],ST_POINT(-90.66184532,40.83660548,4269),15)
      ,(22000700001057,ARRAY[22000300000063,22000300054568],ST_POINT(-90.66170083,40.83691226,4269),20)
      ,(22000700030137,ARRAY[22000300043734],ST_POINT(-90.58736392,40.85062982,4269),15)
      ,(23001100025129,ARRAY[23000300036560,23000200024237,23000200080693],ST_POINT(-95.87988671,41.05347355,4269),25)
      ,(23001100025129,ARRAY[23000200024237,23000300036560],ST_POINT(-95.87970965,41.05317132,4269),15)
      ,(23002100001057,ARRAY[23001100000042,23001100010619],ST_POINT(-96.31285018,41.12142192,4269),25)
      ,(23002000010229,ARRAY[23001100005711,23002000021851],ST_POINT(-97.32411557,41.40760969,4269),15)
      ,(70000500072443,ARRAY[70000500001551,70000500164501],ST_POINT(-119.47368812,40.3832149,4269),15)
      ,(70000500090251,ARRAY[70000500054719,70000500164501],ST_POINT(-119.45988829,40.40217509,4269),25)
      ,(70000500108285,ARRAY[70000500037348,70000500164491,70000500001913,70000500108284],ST_POINT(-119.34597337,40.56619744,4269),15)
      ,(70000500019662,ARRAY[70000500125794,70000500164491],ST_POINT(-119.36151185,40.58067898,4269),40)
      ,(70000500091626,ARRAY[70000500020710,70000500164498],ST_POINT(-119.06421772,40.7810057,4269),25)
      ,(70000500148451,ARRAY[70000500164472],ST_POINT(-118.13306513,41.02627613,4269),15)
      ,(40000300031039,ARRAY[40000200055303,40000200064124],ST_POINT(-114.55698715,32.7181623,4269),15)
      ,(40000200043479,ARRAY[40000200026156,40000200077545],ST_POINT(-113.64334174,33.43036183,4269),25)
      ,(40000200006291,ARRAY[40000200043478,40000200077545],ST_POINT(-113.64722014,33.46829487,4269),25)
      ,(40000200026308,ARRAY[40000200041234,40000200077545,40000200015329,40000200058670],ST_POINT(-113.54857281,33.51058938,4269),100)
      ,(40000200019389,ARRAY[40000200010688,40000200077561],ST_POINT(-114.77967641,33.59198199,4269),25)
      ,(40000200001925,ARRAY[40000200045292,40000200077561],ST_POINT(-114.77392175,33.59589958,4269),15)
      ,(40000200045477,ARRAY[40000200001925,40000200077561],ST_POINT(-114.77233166,33.59706972,4269),15)
      ,(40000200048347,ARRAY[40000200077552],ST_POINT(-114.25151075,33.89061602,4269),25)
      ,(40000200029404,ARRAY[40000200055378,40000200077549],ST_POINT(-114.55211389,34.94626204,4269),25)
      ,(40000200052104,ARRAY[40000200011054,40000200077566],ST_POINT(-114.75118236,35.50056559,4269),15)
      ,(70000100033489,ARRAY[70000100021296,70000100282728],ST_POINT(-115.72660366,35.74332308,4269),30)
      ,(70000100118536,ARRAY[70000100000303,70000100282732],ST_POINT(-115.83956811,35.86258062,4269),25)
      ,(70000100184374,ARRAY[70000100250458,70000100282732],ST_POINT(-115.87552077,35.91025182,4269),25)
      ,(70000100084217,ARRAY[70000100183262,70000100282786],ST_POINT(-116.10544593,36.10373864,4269),60)
      ,(40000500316973,ARRAY[40000500295672,40000500366038],ST_POINT(-114.8418022,36.44768432,4269),70)
      ,(40000500316973,ARRAY[40000500274264,40000500366038],ST_POINT(-114.85388374,36.4575373,4269),40)
      ,(70000100085963,ARRAY[70000100118851,70000100282793],ST_POINT(-115.81489813,37.70232714,4269),20)
      ,(70000100151837,ARRAY[70000100020052,70000100282793],ST_POINT(-115.83525098,37.71199971,4269),25)
      ,(70000100053040,ARRAY[70000100217877,70000100282793],ST_POINT(-115.80552156,37.73245905,4269),15)
      ,(70000100224453,ARRAY[70000100198396,70000100282758],ST_POINT(-115.36258848,37.88954281,4269),15)
      ,(70000100028235,ARRAY[70000100093474,70000100282803],ST_POINT(-115.20497542,37.92785743,4269),15)
      ,(70000100099092,ARRAY[70000100060764,70000100282803,70000100225575],ST_POINT(-115.21330465,37.94142138,4269),25)
      ,(70000100163248,ARRAY[70000100196277,70000100282727],ST_POINT(-114.5930887,38.31218407,4269),15)
      ,(70000100031799,ARRAY[70000100163518,70000100282727],ST_POINT(-114.52616078,38.28657963,4269),15)
      ,(70000100228965,ARRAY[70000100266111,70000100163252,70000100282727,70000100097026],ST_POINT(-114.60011132,38.33729563,4269),30)
      ,(70000100231329,ARRAY[70000100033847,70000100282727],ST_POINT(-114.62322713,38.32943208,4269),25)
      ,(70000100229257,ARRAY[70000100031803,70000100282727],ST_POINT(-114.52823772,38.36701865,4269),15)
      ,(70000100260211,ARRAY[70000100161271,70000100282704],ST_POINT(-114.91940122,38.34438112,4269),15)
      ,(40000500294479,ARRAY[40000500366042,40000500331522],ST_POINT(-115.11371106,38.43669386,4269),30)
      ,(70000100063848,ARRAY[70000100195935,70000100282712],ST_POINT(-114.65843583,38.54807815,4269),25)
      ,(70000100228739,ARRAY[70000100228490,70000100063851,70000100282712],ST_POINT(-114.64999135,38.5787106,4269),15)
      ,(70000100031212,ARRAY[70000100261884,70000100282712],ST_POINT(-114.65323795,38.58212009,4269),15)
      ,(70000100261894,ARRAY[70000100228745,70000100282712],ST_POINT(-114.66571041,38.61687163,4269),35)
      ,(70000100129633,ARRAY[70000100063858,70000100282712],ST_POINT(-114.6491721,38.6229076,4269),25)
      ,(70000100267275,ARRAY[70000100066366,70000100282800],ST_POINT(-115.82782464,38.18217,4269),25)
      ,(70000100019092,ARRAY[70000100165246,70000100282745],ST_POINT(-115.9428725,38.06049402,4269),15)
      ,(70000100198289,ARRAY[70000100150391,70000100282810,70000100216288],ST_POINT(-116.08610947,37.98327608,4269),15)
      ,(70000100218083,ARRAY[70000100198327,70000100282800],ST_POINT(-115.79355681,38.19366463,4269),15)
      ,(70000100218084,ARRAY[70000100218083,70000100282800],ST_POINT(-115.79242126,38.21386977,4269),25)
      ,(70000100130388,ARRAY[70000100163731,70000100282712],ST_POINT(-114.49845093,38.49341628,4269),15)
      ,(70000100064651,ARRAY[70000100130388,70000100282712],ST_POINT(-114.49234886,38.50392985,4269),25)
      ,(70000100097403,ARRAY[70000100000663,70000100282712],ST_POINT(-114.5080335,38.52882761,4269),25)
      ,(70000100229260,ARRAY[70000100000662,70000100282712],ST_POINT(-114.53371964,38.53805926,4269),15)
      ,(70000100033849,ARRAY[70000100000662,70000100282712],ST_POINT(-114.53640973,38.54301898,4269),15)
      ,(70000100262646,ARRAY[70000100097306,70000100282751,70000100196543],ST_POINT(-114.53127762,38.74427289,4269),25)
      ,(70000100097306,ARRAY[70000100064556,70000100282751],ST_POINT(-114.53495624,38.75072151,4269),50)
      ,(70000100163637,ARRAY[70000100196544,70000100282751],ST_POINT(-114.51870488,38.7475885,4269),15)
      ,(70000100196437,ARRAY[70000100262353,70000100282751],ST_POINT(-114.56600853,38.77660317,4269),25)
      ,(70000100064757,ARRAY[70000100196751,70000100282715,70000100196752],ST_POINT(-114.4997332,38.89931106,4269),75)
      ,(70000100196751,ARRAY[70000100262745,70000100282715],ST_POINT(-114.50517508,38.89847412,4269),20)
      ,(70000100262746,ARRAY[70000100229484,70000100282715,70000100032043],ST_POINT(-114.53983081,38.89417205,4269),15)
      ,(70000100262254,ARRAY[70000100097038,70000100229055,70000100282715],ST_POINT(-114.58223258,38.9162905,4269),85)
      ,(70000100031638,ARRAY[70000100229055,70000100282715],ST_POINT(-114.57316735,38.92313214,4269),15)
      ,(70000100032046,ARRAY[70000100262747,70000100282715],ST_POINT(-114.50778945,38.94022424,4269),15)
      ,(70000400027744,ARRAY[70000400027743,70000400095220],ST_POINT(-114.00312402,39.07456482,4269),25)
      ,(70000400011200,ARRAY[70000400038927,70000400094971],ST_POINT(-114.02718175,39.26386519,4269),40)
      ,(70000400046613,ARRAY[70000400000081,70000400094971],ST_POINT(-113.77621502,39.28037262,4269),15)
      ,(70000100267096,ARRAY[70000100267094,70000100282740],ST_POINT(-114.98925832,39.26557399,4269),25)
      ,(70000100251116,ARRAY[70000100053272,70000100282777],ST_POINT(-115.79493131,39.57591266,4269),25)
      ,(70000100184528,ARRAY[70000100118324,70000100282761],ST_POINT(-115.86693926,39.72173066,4269),25)
      ,(70000100184529,ARRAY[70000100217236,70000100282761],ST_POINT(-115.87279453,39.7535796,4269),15)
      ,(70000100266990,ARRAY[70000100250454,70000100282719],ST_POINT(-115.8689232,39.94153945,4269),75)
      ,(70000100082637,ARRAY[70000100214575,70000100282764],ST_POINT(-116.57793054,40.10374319,4269),35)
      ,(70000100247755,ARRAY[70000100247690,70000100282764],ST_POINT(-116.57694014,40.08640142,4269),15)
      ,(70000100206694,ARRAY[70000100074749,70000100282785],ST_POINT(-117.68122059,39.55578031,4269),20)
      ,(70000100238748,ARRAY[70000100205728,70000100282785],ST_POINT(-117.73401096,39.60552077,4269),15)
      ,(70000100239041,ARRAY[70000100173103,70000100282785],ST_POINT(-117.73321179,39.60960635,4269),15)
      ,(70000100139970,ARRAY[70000100239041,70000100282785],ST_POINT(-117.72619422,39.6083629,4269),15)
      ,(70000100008892,ARRAY[70000100239340,70000100282767],ST_POINT(-117.69400402,39.65929879,4269),15)
      ,(70000100173772,ARRAY[70000100140627,70000100282767],ST_POINT(-117.68478692,39.65858372,4269),25)
      ,(70000100041596,ARRAY[70000100008892,70000100282767,70000100173771,70000100107469,70000100282767,70000100206695,70000100074752,70000100239340,70000100266354,70000100107124,70000100173449],ST_POINT(-117.69082767,39.65378755,4269),300)
      ,(70000100140626,ARRAY[70000100239693,70000100282767],ST_POINT(-117.68947031,39.67114877,4269),30)
      ,(70000100239692,ARRAY[70000100041928,70000100282767,70000100140629,70000100008895],ST_POINT(-117.6871941,39.67667896,4269),30)
      ,(70000100003796,ARRAY[70000100282807],ST_POINT(-118.03100311,39.77572891,4269),15)
      ,(70000100131873,ARRAY[70000100044930,70000100282794],ST_POINT(-117.52037379,39.3623253,4269),15)
      ,(70000100079225,ARRAY[70000100178322,70000100282798,70000100178410,70000100211173],ST_POINT(-117.22996309,39.01236488,4269),15)
      ,(70000100079317,ARRAY[70000100211251,70000100282798,70000100178410],ST_POINT(-117.19882179,39.01218718,4269),40)
      ,(70000100079397,ARRAY[70000100079317,70000100282798],ST_POINT(-117.18409391,39.01491539,4269),30)
      ,(70000100046561,ARRAY[70000100079565,70000100282798],ST_POINT(-117.17409127,39.02269997,4269),15)
      ,(70000100211174,ARRAY[70000100145349,70000100282798],ST_POINT(-117.19131541,38.99408269,4269),15)
      ,(70000100013877,ARRAY[70000100178726,70000100282809],ST_POINT(-117.11034447,38.66419847,4269),25)
      ,(70000100076311,ARRAY[70000100109218,70000100282763,70000100174725,70000100109219],ST_POINT(-117.59222478,38.13496759,4269),35)
      ,(70000100076311,ARRAY[70000100109218,70000100109219,70000100174725,70000100282763,70000100076314,70000100010451],ST_POINT(-117.59416965,38.13599215,4269),60)
      ,(70000100076316,ARRAY[70000100208211,70000100282763,70000100142306,70000100142305],ST_POINT(-117.5869964,38.15093517,4269),30)
      ,(70000100076316,ARRAY[70000100208211,70000100142305,70000100207610,70000100142306,70000100142305,70000100207609,70000100043551],ST_POINT(-117.58906905,38.15141687,4269),70)
      ,(70000100241287,ARRAY[70000100175440,70000100282763],ST_POINT(-117.57720265,38.16285155,4269),15)
      ,(70000100142312,ARRAY[70000100175440,70000100282763],ST_POINT(-117.58097622,38.16974541,4269),35)
      ,(70000100142312,ARRAY[70000100230691,70000100282763],ST_POINT(-117.57642732,38.17750902,4269),20)
      ,(70000100000077,ARRAY[70000100010786,70000100282763],ST_POINT(-117.55199219,38.19611102,4269),15)
      ,(70000100189344,ARRAY[70000100122631,70000100282701,70000100189343],ST_POINT(-115.50768784,39.63734562,4269),45)
      ,(70000100189835,ARRAY[70000100090764,70000100282701,70000100089899,70000100189344],ST_POINT(-115.48929355,39.64591575,4269),20)
      ,(70000100255835,ARRAY[70000100282701,70000100255344,70000100099174],ST_POINT(-115.47968073,39.67088622,4269),240)
      ,(70000100099174,ARRAY[70000100282701,70000100057374,70000100156859,70000100189345,70000100024544,70000100255344,70000100255835,70000100255836],ST_POINT(-115.47798829,39.67575635,4269),240)
      ,(70000100159045,ARRAY[70000100257932,70000100282701],ST_POINT(-115.35289224,39.67176729,4269),20)
      ,(70000100257933,ARRAY[70000100159045,70000100282701],ST_POINT(-115.35982343,39.67975388,4269),15)
      ,(70000100224890,ARRAY[70000100092988,70000100282701],ST_POINT(-115.33586051,39.71402955,4269),15)
      ,(70000100258130,ARRAY[70000100258131,70000100282701],ST_POINT(-115.33478669,39.72376104,4269),15)
      ,(70000100092994,ARRAY[70000100092992,70000100282701],ST_POINT(-115.32514298,39.74508997,4269),20)
      ,(70000100027630,ARRAY[70000100099186,70000100282701],ST_POINT(-115.29957441,39.77581701,4269),35)
      ,(70000100225263,ARRAY[70000100258323,70000100282701],ST_POINT(-115.28804618,39.81679853,4269),15)
      ,(70000100093174,ARRAY[70000100126085,70000100282701],ST_POINT(-115.31597587,39.82678707,4269),20)
      ,(70000100225264,ARRAY[70000100093174,70000100282701],ST_POINT(-115.28924238,39.83584169,4269),15)
      ,(70000100091214,ARRAY[70000100123555,70000100282701],ST_POINT(-115.46829888,39.72751703,4269),15)
      ,(70000100000590,ARRAY[70000100090765,70000100282701],ST_POINT(-115.46988611,39.75591733,4269),20)
      ,(70000100255350,ARRAY[70000100000592,70000100282701],ST_POINT(-115.46740277,39.7677472,4269),15)
      ,(70000100066497,ARRAY[70000100000591,70000100282701],ST_POINT(-115.4641563,39.77932877,4269),20)
      ,(70000100256754,ARRAY[70000100025962,70000100282701,70000100091601],ST_POINT(-115.44241921,39.80868322,4269),45)
      ,(70000100165427,ARRAY[70000100057852,70000100282701],ST_POINT(-115.48267868,39.80431325,4269),20)
      ,(70000100258325,ARRAY[70000100060213,70000100282701],ST_POINT(-115.30703654,39.85853147,4269),20)
      ,(70000100093694,ARRAY[70000100159745,70000100282709],ST_POINT(-115.23093814,39.86070773,4269),20)
      ,(70000100093614,ARRAY[70000100258805,70000100282709],ST_POINT(-115.23108041,39.87899341,4269),20)
      ,(70000100093808,ARRAY[70000100093614,70000100282709,70000100060877,70000100028247],ST_POINT(-115.21044741,39.8806679,4269),70)
      ,(70000100093807,ARRAY[70000100028247,70000100282709,70000100225585,70000100060876],ST_POINT(-115.21078311,39.8861173,4269),35)
      ,(70000100093809,ARRAY[70000100093807,70000100282709],ST_POINT(-115.21214314,39.88867445,4269),20)
      ,(70000100093808,ARRAY[70000100093614,70000100282709,70000100028247,70000100060877,70000100093807],ST_POINT(-115.21046861,39.88068042,4269),55)
      ,(70000100160136,ARRAY[70000100028364,70000100282709,70000100126828,70000100160032,70000100093812,70000100258910],ST_POINT(-115.18944628,39.90396541,4269),60)
      ,(70000100028364,ARRAY[70000100259152,70000100282709],ST_POINT(-115.17888789,39.90094352,4269),35)
      ,(70000100231266,ARRAY[70000100225879,70000100282709],ST_POINT(-115.1632473,39.90895044,4269),15)
      ,(70000100061412,ARRAY[70000100193431,70000100282709,70000100127226,70000100226194],ST_POINT(-115.09288588,39.89019988,4269),25)
      ,(70000100061498,ARRAY[70000100094315,70000100282709],ST_POINT(-115.07707231,39.89826086,4269),20)
      ,(70000100160556,ARRAY[70000100061497,70000100282709],ST_POINT(-115.07787391,39.90705206,4269),20)
      ,(70000100127301,ARRAY[70000100226275,70000100282709],ST_POINT(-115.06588593,39.91868576,4269),20)
      ,(70000100028666,ARRAY[70000100094222,70000100282709],ST_POINT(-115.10212022,39.86000618,4269),20)
      ,(70000100028596,ARRAY[70000100193360,70000100282709,70000100028597,70000100193362],ST_POINT(-115.1211525,39.73681575,4269),300)
      ,(70000100028529,ARRAY[70000100000614,70000100282709],ST_POINT(-115.1210159,39.76665506,4269),15)
      ,(70000100028594,ARRAY[70000100193358,70000100282709],ST_POINT(-115.12284283,39.71601221,4269),25)
   ) AS t(expand,static,patch,size)
   LOOP
      IF r.expand = ANY(r.static)
      THEN
         RAISE EXCEPTION 'QA failure for % with same value in static list',r.expand;
      
      END IF;   
   
      BEGIN
         patchgeo := ST_BUFFER(
             ST_TRANSFORM(r.patch,int_srid)
            ,r.size
            ,'quad_segs=2'
         );
         
      EXCEPTION
         WHEN OTHERS THEN
            RAISE WARNING '% % % %',r.expand,r.static,ST_ASEWKT(r.patch),r.size;
            RAISE;
      
      END;
      
      SELECT
      ST_UNION(
         cipsrv_nhdplus_h.snap_to_common_grid(ST_TRANSFORM(a.shape,int_srid),int_srid::VARCHAR,0.001)
      )
      INTO staticgeo
      FROM (
         SELECT
          aa.nhdplusid
         ,aa.shape
         FROM
         cipsrv_nhdplus_h.nhdpluscatchment aa
         UNION ALL
         SELECT
          bb.nhdplusid
         ,bb.shape
         FROM
         cipsrv_epageofab_h.grid0catchment bb
      ) a
      WHERE 
      a.nhdplusid = ANY(r.static);
      
      IF staticgeo IS NULL
      OR ST_ISEMPTY(staticgeo)
      OR ST_SRID(staticgeo) = 0
      THEN
         RAISE EXCEPTION '% % % %',r.expand,r.static,ST_ASEWKT(r.patch),r.size;
         
      END IF;
      
      IF ST_DISTANCE(
          patchgeo
         ,staticgeo
      ) > 50
      THEN
         RAISE EXCEPTION 'QA distance check for % %',r.expand,r.static;
      
      END IF;
      
      BEGIN
         SELECT
         ST_UNION(
             cipsrv_nhdplus_h.snap_to_common_grid(ST_TRANSFORM(a.shape,int_srid),int_srid::VARCHAR,0.001)
            ,cipsrv_nhdplus_h.snap_to_common_grid(patchgeo,int_srid::VARCHAR,0.001)
         )
         INTO step1geo
         FROM
         cipsrv_nhdplus_h.nhdpluscatchment a
         WHERE
         a.nhdplusid = r.expand;
      
      EXCEPTION
         WHEN OTHERS THEN
            RAISE WARNING '% % % %',r.expand,r.static,ST_ASEWKT(r.patch),r.size;
            RAISE;
      
      END;
      
      IF step1geo IS NULL
      OR ST_ISEMPTY(step1geo)
      OR ST_SRID(step1geo) = 0
      THEN
         RAISE EXCEPTION '% % % % %',r.expand,r.static,ST_ASEWKT(r.patch),r.size,ST_ASEWKT(step1geo);
         
      END IF;
      
      BEGIN
         SELECT
         ST_DIFFERENCE(
             step1geo
            ,staticgeo
         )
         INTO step2geo;
      
      EXCEPTION
         WHEN OTHERS THEN
            RAISE WARNING '% % % %',r.expand,r.static,ST_ASEWKT(r.patch),r.size;
            RAISE;
      
      END;
      
      IF step2geo IS NULL
      OR ST_ISEMPTY(step2geo)
      OR ST_SRID(step2geo) = 0
      THEN
         RAISE EXCEPTION '% % % % %',r.expand,r.static,ST_ASEWKT(r.patch),r.size,ST_ASEWKT(step2geo);
         
      END IF;
      
      BEGIN
         UPDATE cipsrv_nhdplus_h.nhdpluscatchment a
         SET shape = ST_TRANSFORM(step2geo,4269)
         WHERE 
         a.nhdplusid = r.expand;
         
      EXCEPTION
         WHEN OTHERS THEN
            RAISE WARNING '% % % %',r.expand,r.static,ST_ASEWKT(r.patch),r.size;
         RAISE;
         
      END;
         
      UPDATE cipsrv_nhdplus_h.nhdpluscatchment a
      SET areasqkm = ST_AREA(ST_TRANSFORM(a.shape,int_srid))::NUMERIC / 1000000
      WHERE 
      a.nhdplusid = r.expand;
        
   END LOOP;
    
END$$;

