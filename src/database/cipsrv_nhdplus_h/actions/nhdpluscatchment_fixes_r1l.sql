DO $$DECLARE 
   r record;
   staticgeo GEOMETRY;
   patchgeo  GEOMETRY;
   step1geo  GEOMETRY;
   step2geo  GEOMETRY;
   int_srid  INTEGER := 5070;
   int_count INTEGER;
   
BEGIN
   /* Remove Overlaps - vals are (keep,clip) */
   FOR r IN SELECT * FROM (VALUES  
       (60003500022665,60003400010459)
      ,(60003500011055,60003400011250)
      ,(60003500011055,60003400021351)
      ,(60003400008491,60003500003422)
      ,(60003400003069,60003500030067)
      ,(60003500022425,60003400003093)
      ,(60003400027723,60003500003313)
      ,(60003400002898,60003500018487)
      ,(60003500006700,60003400011390)
      ,(60003500021865,60003400027964)
      ,(60003500002821,60003400013222)
      ,(60003500029291,60003400003544)
      ,(60003400019729,60003500017875)
      ,(60003500010256,60003400019729)
      ,(60003400026317,60003500010256)
      ,(60003500029290,60003400026317)
      ,(60003400026317,60003500029291)
      ,(60003500029159,60003400021892)
      ,(60003500009877,60003400015276)
      ,(60003400015276,60003500013799)
      ,(60003400028030,60003500013799)
      ,(60003500006038,60003400028030)
      ,(60003400004232,60003500028700)
      ,(60003500001536,60003400010337)
      ,(60003500023918,60003400017832)
      ,(60003400001005,60003500008804)
      ,(60003500009104,60003400001181)
      ,(60003500008910,60003400007472)
      ,(60003500000843,60003400014598)
      ,(60003400017291,60003500000905)
      ,(60003400010839,60003500015898)
      ,(60003400035315,60003500000578)
      ,(60003400037412,60003500011872)
      ,(65000300013157,65000300013196)
      ,(65000300066608,65000300013196)
      ,(65000300013135,65000300013196)
      ,(60003400043919,60003400042760)
      ,(60003400032854,65000300012487)
      ,(65000300039080,60003400033863)
      ,(65000300124391,65000300125977)
      ,(60003400037502,65000300125977)
      ,(65000300125977,60003400037502)
      ,(60003400043698,60003400030164)
      ,(65000300026769,65000300066661)
      ,(60003400043356,65000300053268)
      ,(60003400033047,65000300093526)
      ,(60003400037448,60003400038960)
      ,(60003300056989,60003600004471)
      ,(60003300067936,60003600002599)
      ,(60003300070320,60003600002571)
      ,(60003600003834,60003300070330)
      ,(60003600004453,60003300070330)
      ,(60003600000746,60003300063526)
      ,(60003600002543,60003300061300)
      ,(60003300069803,60003600000731)
      ,(60003600003813,60003300065103)
      ,(60003300065103,60003600001943)
      ,(60003300060638,60003600003154)
      ,(60003600003134,60003300066975)
      ,(60003300066975,60003600001266)
      ,(60003300072350,60003600001898)
      ,(60003300072593,60003600001898)
      ,(60003300072888,60003600001878)
      ,(60003600002449,60003300067799)
      ,(60003300063467,60003600001862)
      ,(60003300072598,60003600003102)
      ,(60003600003110,60003300072598)
      ,(60003600003110,60003300063907)
      ,(60003300059700,60003600002445)
      ,(60003300066416,60003600004297)
      ,(60003300065882,60003600000016)
      ,(65000300112824,65000300087256)
      ,(65000300087453,65000300087256)
      ,(65000300057376,65000300017405)
      ,(65000300003920,65000300084171)
      ,(65000300070656,65000300084171)
      ,(65000300070656,65000300084171)
      ,(65000300030582,65000300084171)
      ,(65000300083466,65000300016510)
      ,(65000300056363,65000300016510)
      ,(65000300043098,65000300016510)
      ,(65000300016304,65000300016510)
      ,(65000300095869,65000300015685)
      ,(65000300133276,65000300082356)
      ,(65000300095504,65000300082356)
      ,(65000300068854,65000300082356)
      ,(65000300124889,65000300082356)
      ,(24001000063730,24001300281878)
      ,(23002800210920,23002800168042)
      ,(65000400006846,23002800210882)
      ,(23002800020402,23002800040435)
      ,(23002800060372,23002800040435)
      ,(65000400006937,23002800140552)
      ,(65000400012311,23002800020425)
      ,(65000400006957,23002800020425)
      ,(23002800120503,23002800020425)
      ,(23002800140551,23002800040435)
      ,(23002800100447,23002800080358)
      ,(65000400008787,23002800080358)
      ,(23002800120532,23002800120531)
      ,(65000400010566,23002800120531)
      ,(23002800120531,23002800040478)
      ,(65000400003413,23002800040478)
      ,(65000400006989,23002800120555)
      ,(23002800210200,23002800040385)
      ,(23002800172816,23002800040385)
   ) AS t(keep,clip)
   LOOP
      IF r.keep = r.clip
      OR r.keep IS NULL
      OR r.clip IS NULL
      THEN
         RAISE EXCEPTION 'QA problem % %',r.keep,r.clip;
      
      END IF;
      
      SELECT 
      cipsrv_nhdplus_h.snap_to_common_grid(ST_TRANSFORM(b.shape,int_srid),int_srid::VARCHAR,0.001)
      INTO
      step1geo
      FROM (
         SELECT
          aa.nhdplusid
         ,aa.shape
         FROM
         cipsrv_nhdplus_h.nhdpluscatchment aa
         UNION ALL
         SELECT
          bb.nhdplusid
         ,bb.shape
         FROM
         cipsrv_epageofab_h.grid0catchment bb
      ) b 
      WHERE 
      b.nhdplusid = r.keep;
      
      IF step1geo IS NULL
      OR ST_ISEMPTY(step1geo)
      OR ST_SRID(step1geo) = 0
      THEN
         RAISE EXCEPTION '% %',r.keep,r.clip;
         
      END IF;
      
      UPDATE cipsrv_nhdplus_h.nhdpluscatchment a
      SET shape = ST_TRANSFORM(ST_DIFFERENCE(
          cipsrv_nhdplus_h.snap_to_common_grid(ST_TRANSFORM(a.shape,int_srid),int_srid::VARCHAR,0.001)
         ,step1geo
      ),4269)
      WHERE 
      a.nhdplusid = r.clip;
      
      GET DIAGNOSTICS int_count = ROW_COUNT;

      IF int_count != 1
      THEN
         RAISE EXCEPTION 'error finding % in nhdpluscatchment',r.keep;

      END IF;         
      
      UPDATE cipsrv_nhdplus_h.nhdpluscatchment a
      SET areasqkm = ST_AREA(ST_TRANSFORM(a.shape,int_srid))::NUMERIC / 1000000
      WHERE 
      a.nhdplusid = r.clip;
        
   END LOOP;
   
   /* Remove Gaps I - vals are (expand,static,patch,size)*/
   FOR r IN SELECT * FROM (VALUES
       (60003400008054,ARRAY[60003500000013,60003500022799],ST_POINT(-88.39986831,50.67024425,4269),15)
      ,(65000300013196,ARRAY[65000300013157,65000300106776],ST_POINT(-90.3174483,49.00332032,4269),15)
      ,(65000300129161,ARRAY[60003400042442],ST_POINT(-90.81329361,48.66909542,4269),15)
      ,(65000300039204,ARRAY[60003400040762],ST_POINT(-90.77203594,48.71509945,4269),15)
      ,(60003400045845,ARRAY[65000300093525],ST_POINT(-89.91679428,48.81348092,4269),15)
      ,(60003300067448,ARRAY[60003600004031],ST_POINT(-86.9340454,49.29179523,4269),25)
      ,(60003600004471,ARRAY[60003300056989],ST_POINT(-87.0837972,49.09200261,4269),35)
      ,(60003600003242,ARRAY[60003300070320],ST_POINT(-87.10382689,49.11479468,4269),35)
      ,(60003300070330,ARRAY[60003600003834],ST_POINT(-87.11300713,49.14248275,4269),35)
      ,(60003600002600,ARRAY[60003300070330],ST_POINT(-87.09853818,49.15091263,4269),35)
      ,(60003600003812,ARRAY[60003300063092],ST_POINT(-87.13810046,49.20728712,4269),35)
      ,(60003300063092,ARRAY[60003600002543],ST_POINT(-87.14453618,49.21113958,4269),35)
      ,(60003300061300,ARRAY[60003600003201],ST_POINT(-87.14122615,49.22697763,4269),35)
      ,(60003300069803,ARRAY[60003600000731],ST_POINT(-87.13417835,49.24145977,4269),35)
      ,(60003300057119,ARRAY[60003600003813],ST_POINT(-87.14560144,49.25826785,4269),35)
      ,(60003300058015,ARRAY[60003600000136],ST_POINT(-87.14733757,49.27789172,4269),35)
      ,(60003300060638,ARRAY[60003600004357],ST_POINT(-87.18265383,49.26179759,4269),35)
      ,(60003300060638,ARRAY[60003600004357],ST_POINT(-87.18976131,49.25971653,4269),35)
      ,(60003600004357,ARRAY[60003300060638],ST_POINT(-87.19116061,49.25953755,4269),35)
      ,(60003300060638,ARRAY[60003600004357],ST_POINT(-87.19243788,49.25912264,4269),35)
      ,(60003600003154,ARRAY[60003300060638],ST_POINT(-87.19305162,49.25362826,4269),35)
      ,(60003600003147,ARRAY[60003300068171],ST_POINT(-87.20559458,49.24753121,4269),35)
      ,(60003300068171,ARRAY[60003600003147],ST_POINT(-87.20613803,49.24438115,4269),35)
      ,(60003300068171,ARRAY[60003600003147],ST_POINT(-87.20853799,49.24378726,4269),35)
      ,(60003300072350,ARRAY[60003600001898],ST_POINT(-87.25276908,49.20334131,4269),35)
      ,(60003300072888,ARRAY[60003600003118],ST_POINT(-87.28341691,49.18306987,4269),35)
      ,(60003300072490,ARRAY[60003600001878],ST_POINT(-87.29754919,49.17503886,4269),35)
      ,(60003300067799,ARRAY[60003600002449],ST_POINT(-87.32762109,49.17260022,4269),35)
      ,(60003300072575,ARRAY[60003600001852,60003600000636],ST_POINT(-87.34070824,49.16644515,4269),35)
      ,(60003600003709,ARRAY[60003300072575],ST_POINT(-87.33992427,49.15817374,4269),35)
      ,(60003300063467,ARRAY[60003600001862],ST_POINT(-87.33839356,49.131696,4269),35)
      ,(60003600003728,ARRAY[60003300064414,60003600001248],ST_POINT(-87.32816894,49.12670592,4269),35)
      ,(60003600000058,ARRAY[60003300056412,60003300072598],ST_POINT(-87.31494262,49.11939406,4269),35)
      ,(60003300056412,ARRAY[60003600000058],ST_POINT(-87.31512461,49.12059383,4269),35)
      ,(60003600003102,ARRAY[60003300072598,60003600003727,60003600000058],ST_POINT(-87.31650637,49.11857175,4269),35)
      ,(60003600003110,ARRAY[60003300065554],ST_POINT(-87.29525687,49.10206837,4269),35)
      ,(60003600001247,ARRAY[60003300059700,60003600002444],ST_POINT(-87.32633558,49.09312746,4269),35)
      ,(60003300066044,ARRAY[60003600001247],ST_POINT(-87.33643479,49.09282208,4269),35)
      ,(60003600001849,ARRAY[60003300067604],ST_POINT(-87.34433687,49.09668477,4269),35)
      ,(60003600002419,ARRAY[60003300064002],ST_POINT(-87.38395954,49.09993364,4269),35)
      ,(60003300066416,ARRAY[60003600004297,60003300067888],ST_POINT(-87.3959556,49.10250581,4269),35)
      ,(60003300069983,ARRAY[60003600004297,60003300067888],ST_POINT(-87.40365488,49.10353475,4269),35)
      ,(60003600000016,ARRAY[60003300072745],ST_POINT(-87.41193152,49.11370227,4269),35)
      ,(60003600000600,ARRAY[60003300072745,60003600003061],ST_POINT(-87.41343895,49.11895262,4269),35)
      ,(60003300072745,ARRAY[60003600003061],ST_POINT(-87.41466598,49.11873789,4269),35)
      ,(60003400030145,ARRAY[60003700028312,60003700028473],ST_POINT(-89.82502045,48.21931565,4269),35)
      ,(65000300125171,ARRAY[65000300105455],ST_POINT(-90.92880611,49.08221445,4269),275)
      ,(65000300125171,ARRAY[65000300038698,65000300105455],ST_POINT(-90.92423694,49.08197112,4269),700)
      ,(65000300125171,ARRAY[65000300105455,65000300065373],ST_POINT(-90.92309211,49.08771427,4269),390)
      ,(65000300125171,ARRAY[65000300065373,65000300078930],ST_POINT(-90.91733629,49.0879255,4269),620)
      ,(65000300125171,ARRAY[65000300078930,65000300025456],ST_POINT(-90.90624709,49.08301456,4269),1200)
      ,(65000300125171,ARRAY[65000300038698,65000300025456],ST_POINT(-90.91812837,49.07662507,4269),850)
      ,(65000300125171,ARRAY[65000300078930],ST_POINT(-90.90223385,49.08623571,4269),1200)
      ,(65000300087256,ARRAY[65000300026894],ST_POINT(-92.38472944,48.88339261,4269),350)
      ,(65000300116951,ARRAY[65000300047667,65000300020924],ST_POINT(-92.27686404,49.01661784,4269),750)
      ,(65000300116951,ARRAY[65000300007532,65000300021011],ST_POINT(-92.27094244,49.02219337,4269),700)
      ,(65000300116951,ARRAY[65000300007458,65000300007532],ST_POINT(-92.27942506,49.02375858,4269),350)
      ,(65000300116951,ARRAY[65000300007458],ST_POINT(-92.28420221,49.02400369,4269),180)
      ,(65000300116951,ARRAY[65000300034214,65000300047587,65000300034215],ST_POINT(-92.28449752,49.02159198,4269),270)
      ,(65000300116951,ARRAY[65000300034215,65000300020924,65000300047667],ST_POINT(-92.28156902,49.01681779,4269),400)
      ,(65000300116951,ARRAY[65000300007532,65000300021011,65000300101237],ST_POINT(-92.26520387,49.02707984,4269),600)
      ,(65000300116951,ARRAY[65000300087915,65000300101237],ST_POINT(-92.25946992,49.02781812,4269),500)
      ,(65000300116951,ARRAY[65000300087915,65000300124117],ST_POINT(-92.25217789,49.0237699,4269),900)
      ,(65000300116951,ARRAY[65000300124117,65000300047806,65000300021167],ST_POINT(-92.24587177,49.02292395,4269),750)
      ,(65000300116951,ARRAY[65000300047807,65000300021167],ST_POINT(-92.24964006,49.01311871,4269),1200)
      ,(65000300017405,ARRAY[65000300070805,65000300004018],ST_POINT(-93.41336742,48.61084615,4269),200)
      ,(65000300017405,ARRAY[65000300004018,65000300070805],ST_POINT(-93.41049464,48.61135015,4269),230)
      ,(65000300017405,ARRAY[65000300084172,65000300030742],ST_POINT(-93.4192478,48.60728683,4269),50)
      ,(65000300017405,ARRAY[65000300084172,65000300017304],ST_POINT(-93.42460656,48.6063001,4269),75)
      ,(65000300017405,ARRAY[65000300084171],ST_POINT(-93.43184649,48.612229,4269),300)
      ,(65000300017405,ARRAY[65000300084171,65000300110065],ST_POINT(-93.43038396,48.6216779,4269),300)
      ,(65000300084171,ARRAY[65000300066748],ST_POINT(-93.45790294,48.62853968,4269),5)
      ,(65000300084171,ARRAY[65000300003839,65000300070656],ST_POINT(-93.45941456,48.60526044,4269),30)
      ,(65000300017405,ARRAY[65000300084172],ST_POINT(-93.42513416,48.60567488,4269),3)
      ,(65000300096613,ARRAY[65000300029916,65000300056524],ST_POINT(-93.63966419,48.57256878,4269),1000)
      ,(65000300096613,ARRAY[65000300069955,65000300003236],ST_POINT(-93.63077641,48.5729015,4269),750)
      ,(65000300096613,ARRAY[65000300003236,65000300070030,65000300070029],ST_POINT(-93.62475919,48.56754795,4269),500)
      ,(65000300096613,ARRAY[65000300070029,65000300030084,65000300096812,65000300083463],ST_POINT(-93.62796049,48.56339317,4269),500)
      ,(65000300096613,ARRAY[65000300056524,65000300029994,65000300096812,65000300056523],ST_POINT(-93.63261343,48.56098741,4269),500)
      ,(65000300096613,ARRAY[65000300003236,65000300056524,65000300070030],ST_POINT(-93.63152856,48.56887527,4269),820)
      ,(65000300015685,ARRAY[65000300069108],ST_POINT(-93.89371003,48.69393111,4269),120)
      ,(65000300082356,ARRAY[65000300133276,65000300068714],ST_POINT(-94.00696065,48.75918162,4269),75)
      ,(65000300082356,ARRAY[65000300042203],ST_POINT(-93.97503521,48.78072041,4269),800)
      ,(65000300082356,ARRAY[65000300015298],ST_POINT(-94.00583369,48.77377991,4269),50)
      ,(65000300082356,ARRAY[65000300068716,65000300015298],ST_POINT(-94.00399499,48.77555793,4269),50)
      ,(65000300080247,ARRAY[65000300066713,65000300066819,65000300053445],ST_POINT(-95.34881327,49.08261434,4269),1000)
      ,(65000300080247,ARRAY[65000300066713,65000300000106,65000300053445],ST_POINT(-95.3565934,49.08417668,4269),1000)
      ,(65000300080247,ARRAY[65000300066713,65000300000106],ST_POINT(-95.36916544,49.08262507,4269),800)
      ,(65000300080247,ARRAY[65000300066713,65000300000106],ST_POINT(-95.37957666,49.08092426,4269),1000)
      ,(65000300080247,ARRAY[65000300066713],ST_POINT(-95.39126348,49.08104859,4269),1200)
      ,(65000300080247,ARRAY[65000300013390,65000300000094],ST_POINT(-95.39716906,49.09553279,4269),700)
      ,(65000300080247,ARRAY[65000300093608,65000300000094],ST_POINT(-95.41065863,49.09385436,4269),1100)
      ,(65000300080247,ARRAY[65000300093608,65000300000089],ST_POINT(-95.42079136,49.09267325,4269),1200)
      ,(65000300080247,ARRAY[65000300000089,65000300026922],ST_POINT(-95.43545428,49.0815459,4269),2000)
      ,(65000300080247,ARRAY[65000300026922,65000300053430],ST_POINT(-95.44866412,49.06862745,4269),1500)
      ,(65000300080247,ARRAY[65000300026922,65000300053430,65000200083097],ST_POINT(-95.44536166,49.06241106,4269),1600)
      ,(65000300080247,ARRAY[65000200083097,65000300066713],ST_POINT(-95.43403228,49.05978852,4269),1500)
      ,(65000300080247,ARRAY[65000300066713,65000300000089],ST_POINT(-95.4167507,49.07265646,4269),2700)
      ,(65000300110550,ARRAY[65000300055089,65000300114794],ST_POINT(-94.09596845,49.72338908,4269),500)
      ,(65000300110550,ARRAY[65000300055089,65000300123087],ST_POINT(-94.10217464,49.72554949,4269),610)
      ,(65000300110550,ARRAY[65000300123087,65000300001720,65000300015029],ST_POINT(-94.10496277,49.73016614,4269),610)
      ,(65000300110550,ARRAY[65000300015027,65000300028541,65000300015029],ST_POINT(-94.11025996,49.72941856,4269),550)
      ,(65000300110550,ARRAY[65000300015027,65000300095248,65000300095247],ST_POINT(-94.11454776,49.72352046,4269),850)
      ,(65000300110550,ARRAY[65000300095247,65000300115488],ST_POINT(-94.11717356,49.71775165,4269),800)
      ,(65000300110550,ARRAY[65000300108096,65000300055026,65000300028539],ST_POINT(-94.10973378,49.70593552,4269),900)
      ,(65000300110550,ARRAY[65000300028539,65000300081830,65000300095246,65000300115488],ST_POINT(-94.1176112,49.70693015,4269),750)
      ,(65000300138431,ARRAY[65000300000024,65000300115433],ST_POINT(-94.54509087,49.70034123,4269),750)
      ,(65000300138431,ARRAY[65000300115433,65000300094404,65000300014186,65000300054159,65000300094403,65000300067593],ST_POINT(-94.55613587,49.70133709,4269),750)
      ,(65000300138431,ARRAY[65000300094403,65000300067593],ST_POINT(-94.55435238,49.69660404,4269),650)
      ,(65000300138431,ARRAY[65000300000776,65000300110540,65000300054185],ST_POINT(-94.55061337,49.68458852,4269),1210)
      ,(65000300138431,ARRAY[65000300000776,65000300081013],ST_POINT(-94.5652712,49.67485907,4269),900)
      ,(65000300138431,ARRAY[65000300040897,65000300081014,65000300108457,65000300081013],ST_POINT(-94.57424243,49.67743643,4269),700)
      ,(65000300111746,ARRAY[65000300040876],ST_POINT(-94.62510773,49.6161542,4269),1200)
      ,(65000300111746,ARRAY[65000300040876,65000300013333],ST_POINT(-94.6095474,49.61092028,4269),1500)
      ,(65000300111746,ARRAY[65000300013333,65000300094288],ST_POINT(-94.63083676,49.60710092,4269),1600)
      ,(65000300111746,ARRAY[65000300027593,65000300126760],ST_POINT(-94.64349721,49.61410307,4269),900)
      ,(65000300111746,ARRAY[65000300126760,65000300027593,65000300014069,65000300027566,65000300080881,65000300094288],ST_POINT(-94.64455814,49.60865696,4269),1350)
      ,(65000300126030,ARRAY[65000300107428,65000300013930],ST_POINT(-94.71805381,49.61881643,4269),1000)
      ,(65000300126030,ARRAY[65000300116039,65000300107428],ST_POINT(-94.70433809,49.61297707,4269),1000)
      ,(65000300126030,ARRAY[65000300116039,65000300067419,65000300027497],ST_POINT(-94.70958899,49.6080883,4269),910)
      ,(65000300126030,ARRAY[65000300040710,65000300094198,65000300013990],ST_POINT(-94.72553906,49.61511002,4269),600)
      ,(65000300126030,ARRAY[65000300067395,65000300067361,65000300013990,65000300094198,65000300040710],ST_POINT(-94.7300494,49.61003475,4269),600)
      ,(65000300126030,ARRAY[65000300067395,65000300027497,65000300067419],ST_POINT(-94.71456829,49.60935576,4269),1000)
      ,(65000300126030,ARRAY[65000300116039,65000300067419,65000300027497],ST_POINT(-94.70886473,49.60514598,4269),660)
      ,(65000300000005,ARRAY[65000300093734],ST_POINT(-95.19135935,49.25215854,4269),800)
      ,(65000300000005,ARRAY[65000300093734,65000300114913],ST_POINT(-95.20566353,49.25405973,4269),1100)
      ,(65000300000005,ARRAY[65000300093734,65000300114913],ST_POINT(-95.22279227,49.2534085,4269),2000)
      ,(65000300000005,ARRAY[65000300114913,65000300053502,65000300040230],ST_POINT(-95.24710528,49.2534085,4269),1800)
      ,(65000300000005,ARRAY[65000300114913,65000300013452,65000300000157,65000300093691,65000300053488,65000300053502],ST_POINT(-95.26633466,49.24832487,4269),1950)
      ,(24000600018531,ARRAY[60001200051591],ST_POINT(-81.76692597,41.08795467,4269),25)
      ,(23002800040435,ARRAY[23002800180790,23002800020402],ST_POINT(-112.78834784,49.18513188,4269),40)
      ,(23002800040435,ARRAY[23002800180790,23002800020402],ST_POINT(-112.78901074,49.18523546,4269),50)
      ,(23002800040435,ARRAY[65000400010517,23002800080321],ST_POINT(-112.79077003,49.18550545,4269),250)
      ,(23002800040435,ARRAY[65000400005162,23002800192632],ST_POINT(-112.79845406,49.19674764,4269),130)
      ,(23002800040435,ARRAY[65000400003375],ST_POINT(-112.79969444,49.20312362,4269),130)
      ,(23002800120555,ARRAY[65000400001705,65000400003437],ST_POINT(-112.75179653,49.25839211,4269),300)
      ,(23002800120555,ARRAY[65000400014106,65000400006983,65000400003437],ST_POINT(-112.75539367,49.26088163,4269),250)
      ,(23002800120555,ARRAY[65000400014106,65000400006983,65000400006982],ST_POINT(-112.75658624,49.26077402,4269),220)
      ,(23002800120555,ARRAY[65000400006984,65000400003419],ST_POINT(-112.7562885,49.26168019,4269),220)
      ,(23002800120555,ARRAY[65000400003419,65000400001687,65000400001684,65000400014106,65000400006982],ST_POINT(-112.75881281,49.26124005,4269),220)
      ,(23002800120555,ARRAY[65000400006984,65000400003419],ST_POINT(-112.75481275,49.26445045,4269),350)
      ,(23002800120555,ARRAY[65000400006985,65000400010589,65000400014105,65000400005222,65000400014104,65000400006984],ST_POINT(-112.75454091,49.26714305,4269),290)
      ,(23002800120555,ARRAY[23002800166510,23002800200510],ST_POINT(-112.73831283,49.27142791,4269),100)
      ,(23002800120555,ARRAY[65000400012363,23002800166510],ST_POINT(-112.74168114,49.27487012,4269),75)
      ,(23002800120555,ARRAY[23002800165684,23002800204541,65000400012363,65000400001710,65000400006989,65000400014109],ST_POINT(-112.73997909,49.27655097,4269),75)
   ) AS t(expand,static,patch,size)
   LOOP
      IF r.expand = ANY(r.static)
      THEN
         RAISE EXCEPTION 'QA failure for % with same value in static list',r.expand;
      
      END IF;   
   
      BEGIN
         patchgeo := ST_BUFFER(
             ST_TRANSFORM(r.patch,int_srid)
            ,r.size
            ,'quad_segs=2'
         );
         
      EXCEPTION
         WHEN OTHERS THEN
            RAISE WARNING '% % % %',r.expand,r.static,ST_ASEWKT(r.patch),r.size;
            RAISE;
      
      END;
      
      SELECT
      ST_UNION(
         cipsrv_nhdplus_h.snap_to_common_grid(ST_TRANSFORM(a.shape,int_srid),int_srid::VARCHAR,0.001)
      )
      INTO staticgeo
      FROM (
         SELECT
          aa.nhdplusid
         ,aa.shape
         FROM
         cipsrv_nhdplus_h.nhdpluscatchment aa
         UNION ALL
         SELECT
          bb.nhdplusid
         ,bb.shape
         FROM
         cipsrv_epageofab_h.grid0catchment bb
      ) a
      WHERE 
      a.nhdplusid = ANY(r.static);
      
      IF staticgeo IS NULL
      OR ST_ISEMPTY(staticgeo)
      OR ST_SRID(staticgeo) = 0
      THEN
         RAISE EXCEPTION '% % % %',r.expand,r.static,ST_ASEWKT(r.patch),r.size;
         
      END IF;
      
      IF ST_DISTANCE(
          patchgeo
         ,staticgeo
      ) > 50
      THEN
         RAISE EXCEPTION 'QA distance check for % %',r.expand,r.static;
      
      END IF;
      
      BEGIN
         SELECT
         ST_UNION(
             cipsrv_nhdplus_h.snap_to_common_grid(ST_TRANSFORM(a.shape,int_srid),int_srid::VARCHAR,0.001)
            ,cipsrv_nhdplus_h.snap_to_common_grid(patchgeo,int_srid::VARCHAR,0.001)
         )
         INTO step1geo
         FROM
         cipsrv_nhdplus_h.nhdpluscatchment a
         WHERE
         a.nhdplusid = r.expand;
      
      EXCEPTION
         WHEN OTHERS THEN
            RAISE WARNING '% % % %',r.expand,r.static,ST_ASEWKT(r.patch),r.size;
            RAISE;
      
      END;
      
      IF step1geo IS NULL
      OR ST_ISEMPTY(step1geo)
      OR ST_SRID(step1geo) = 0
      THEN
         RAISE EXCEPTION '% % % % %',r.expand,r.static,ST_ASEWKT(r.patch),r.size,ST_ASEWKT(step1geo);
         
      END IF;
      
      BEGIN
         SELECT
         ST_DIFFERENCE(
             step1geo
            ,staticgeo
         )
         INTO step2geo;
      
      EXCEPTION
         WHEN OTHERS THEN
            RAISE WARNING '% % % %',r.expand,r.static,ST_ASEWKT(r.patch),r.size;
            RAISE;
      
      END;
      
      IF step2geo IS NULL
      OR ST_ISEMPTY(step2geo)
      OR ST_SRID(step2geo) = 0
      THEN
         RAISE EXCEPTION '% % % % %',r.expand,r.static,ST_ASEWKT(r.patch),r.size,ST_ASEWKT(step2geo);
         
      END IF;
      
      BEGIN
         UPDATE cipsrv_nhdplus_h.nhdpluscatchment a
         SET shape = ST_TRANSFORM(step2geo,4269)
         WHERE 
         a.nhdplusid = r.expand;
         
      EXCEPTION
         WHEN OTHERS THEN
            RAISE WARNING '% % % %',r.expand,r.static,ST_ASEWKT(r.patch),r.size;
         RAISE;
         
      END;
         
      UPDATE cipsrv_nhdplus_h.nhdpluscatchment a
      SET areasqkm = ST_AREA(ST_TRANSFORM(a.shape,int_srid))::NUMERIC / 1000000
      WHERE 
      a.nhdplusid = r.expand;
        
   END LOOP;
    
END$$;

