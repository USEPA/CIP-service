DO $$DECLARE 
   r record;
   staticgeo GEOMETRY;
BEGIN
   /* Remove Overlaps - vals are (keep,clip) */
   FOR r IN SELECT * FROM (VALUES
       (60001800017446,60002600007118)
      ,(60001800017677,60002600009145)
      ,(60001800016056,60002600010685)
      ,(60001800017313,60002600006252)
      ,(60001800017364,60002600016436)
      ,(60001800017364,60002600017235)
      ,(60001800017827,60002600007970)
      ,(60001800017144,60002600012142)
      ,(60001800017710,60002600012142)
      ,(60001800019626,60002600013789)
      ,(60001800019569,60002600019679)
      ,(60001800019913,60002600019679)
      ,(60001800017889,60002600020656)
      ,(60001800019996,60002600006431)
      ,(60001800011880,60002600014488)
      ,(60001800003234,60002600012135)
      ,(60001800017530,60002500028266)
      ,(60001800014713,60002600009873)
      ,(60001800006892,60002600001203)
      ,(60001800006892,60002600014809)
      ,(60001800019410,60002600010698)
      ,(60001800003235,60002600010698)
      ,(60001800001676,60002600010698)
      ,(60001800015414,60002600010698)
      ,(60001800005602,60002600010698)
      ,(60001800003964,60002600010698)
      ,(60001800016037,60002600010698)
      ,(60001800013964,60002600010698)
      ,(60001800005931,60002600010698)
      ,(60001800019911,60002600010698)
      ,(60001800008604,60002600010698)
      ,(60001800007129,60002600010698)
      ,(60001800014615,60002600010698)
      ,(60001800000309,60002600010698)
      ,(60001800002116,60002600010698)
      ,(60001800000309,60002600018109)
      ,(60001800007129,60002600009887)
      ,(60001800017728,60002600014501)
      ,(60001800017728,60002600010235)
      ,(60001300003102,60002600016905)
      ,(60001300023408,60002600016925)
      ,(60001300025752,60002600017584)
      ,(60001300025752,60002600009892)
      ,(60001300117756,60002600009892)
      ,(60001300007466,60002600007513)
      ,(60001300024567,60002600004284)
      ,(60001300023191,60002600012344)
      ,(60001300023191,60002600143292)
      ,(60001300010685,60002600003404)
      ,(60001300010685,60002600006402)
      ,(60001900002643,60002500009230)
      ,(60001900007200,60002500007088)
      ,(60001900005280,60002500007088)
      ,(60001900005280,60002500014441)
      ,(60001900005280,60002500004422)
      ,(60001900000440,60002500004422)
      ,(60001900004782,60002500004422)
      ,(60001900006538,60002500004422)
      ,(60001900006538,60002500020720)
      ,(60001900008558,60002500020720)
      ,(60001900008558,60002500025639)
      ,(60001900009057,60002500026456)
      ,(60001900000149,60002500026992)
      ,(60001900006882,60002500026992)
      ,(60001900006882,60002500020831)
      ,(60001900007285,60002500020831)
      ,(60001900006999,60002500020831)
      ,(60001900004786,60002500004656)
      ,(60001900004786,60002500014124)
      ,(60001900004786,60002500011489)
      ,(60001900004786,60002500022545)
      ,(60001900010039,60002500022545)
      ,(60001900004774,60002500022545)
      ,(60001900005473,60002500022545)
      ,(60001900008604,60002500022545)
      ,(60001900006776,60002500022545)
      ,(60001900006776,60002500026476)
      ,(60001900005437,60002500011585)
      ,(60001900006113,60002500011585)
      ,(60001900006113,60002500025117)
      ,(60001900006113,60002500012015)
      ,(60001900007637,60002500002083)
      ,(60001900004921,60002500023184)
      ,(60001900005060,60002500018213)
      ,(60001900009393,60002500018213)
      ,(60001900009289,60002500018213)
      ,(60002500002295,60001900009412)
      ,(60002500002295,60001900009289)
      ,(60002500002295,60001900001800)
      ,(60001900006475,60002500002295)
      ,(60001900006475,60002500007600)
      ,(60001900006475,60002500014521)
      ,(60001900006475,60002500002070)
      ,(60001900006475,60002500014521)
      ,(60001900006017,60002500021148)
      ,(60001900005329,60002500021148)
      ,(60001900006489,60002500020491)
      ,(60001900006489,60002500023498)
      ,(60001900005329,60002500023498)
      ,(60001900005329,60002500023498)
      ,(60001900005329,60002500020043)
      ,(60001900005329,60002500007817)
      ,(60001900006878,60002500001584)
      ,(60001900006226,60002500006296)
      ,(60001900006226,60002500001584)
   ) AS t(keep,clip)
   LOOP
      UPDATE cipsrv_nhdplus_h.nhdpluscatchment a
      SET shape = ST_TRANSFORM(ST_DIFFERENCE(
          cipsrv_nhdplus_h.snap_to_common_grid(ST_TRANSFORM(a.shape,5070),'5070',0.001)
         ,(
           SELECT 
           cipsrv_nhdplus_h.snap_to_common_grid(ST_TRANSFORM(b.shape,5070),'5070',0.001) 
           FROM 
           cipsrv_nhdplus_h.nhdpluscatchment b 
           WHERE 
           b.nhdplusid = r.keep
          )
      ),4269)
      WHERE 
      a.nhdplusid = r.clip;
      
      UPDATE cipsrv_nhdplus_h.nhdpluscatchment a
      SET areasqkm = ST_AREA(ST_TRANSFORM(a.shape,5070))::NUMERIC / 1000000
      WHERE 
      a.nhdplusid = r.clip;
        
   END LOOP;
   
   /* Remove Gaps - vals are (expand,static,patch,size)*/
   FOR r IN SELECT * FROM (VALUES
       (60001900006882,ARRAY[60002500017489],ST_POINT(-84.6570176,44.4918871,4269),15)
      ,(60001900006882,ARRAY[60002500017489],ST_POINT(-84.6524164,44.4913155,4269),15)
      ,(60001900009621,ARRAY[60001900006882,60002500026992],ST_POINT(-84.6348101,44.4888228,4269),15)
      ,(60001900009621,ARRAY[60002500026992],ST_POINT(-84.6295302,44.4862813,4269),15)
      ,(60001900009621,ARRAY[60002500026992],ST_POINT(-84.6248038,44.4864175,4269),15)
      ,(60001900002643,ARRAY[60002500026992],ST_POINT(-84.6121481,44.4735153,4269),15)
      ,(60001900002643,ARRAY[60002500009230],ST_POINT(-84.6181724,44.4618121,4269),15)     
      ,(60001900006999,ARRAY[60002500020831],ST_POINT(-84.7064125,44.5139123,4269),15)
      ,(60001900006999,ARRAY[60002500020831],ST_POINT(-84.7092246,44.5144378,4269),15)
      ,(60001900006999,ARRAY[60002500020831],ST_POINT(-84.7132628,44.5139491,4269),15)
      ,(60001900006999,ARRAY[60002500020831],ST_POINT(-84.7128387,44.5139123,4269),15)
      ,(60001900006999,ARRAY[60002500020831],ST_POINT(-84.7181677,44.5149172,4269),15)
      ,(60001900006999,ARRAY[60002500020831],ST_POINT(-84.7202975,44.5135711,4269),15)
      ,(60001900006999,ARRAY[60002500020831],ST_POINT(-84.7219110,44.5137094,4269),15)
      ,(60001900006999,ARRAY[60002500020831],ST_POINT(-84.7229251,44.5136725,4269),15)
      ,(60001900006999,ARRAY[60002500015505],ST_POINT(-84.7472788,44.5207069,4269),15)
      ,(60001900006999,ARRAY[60002500015505],ST_POINT(-84.7519417,44.5217507,4269),15)
      ,(60001900006019,ARRAY[60002500015505,60001900010039],ST_POINT(-84.758957,44.5231865,4269),15)
      ,(60001900004786,ARRAY[60002500024470],ST_POINT(-84.8089825,44.5239477,4269),15)
      ,(60001900004786,ARRAY[60002500024470],ST_POINT(-84.8108271,44.5238195,4269),25)
      ,(60001900004786,ARRAY[60002500024470],ST_POINT(-84.8210746,44.5228902,4269),15)
      ,(60001900004786,ARRAY[60002500024470],ST_POINT(-84.8398596,44.5206744,4269),15)
      ,(60001900004786,ARRAY[60002500024470],ST_POINT(-84.8428699,44.5208371,4269),15)
      ,(60001900004786,ARRAY[60002500024470],ST_POINT(-84.8482556,44.5182110,4269),15)
      ,(60001900004786,ARRAY[60002500024470],ST_POINT(-84.8531704,44.5161757,4269),15)
      ,(60001900004786,ARRAY[60002500024470],ST_POINT(-84.8596040,44.5149011,4269),15)
      ,(60001900004786,ARRAY[60002500024470],ST_POINT(-84.8482556,44.5182110,4269),15)
      ,(60001900004786,ARRAY[60002500004656],ST_POINT(-84.8680880,44.5181567,4269),15)
      ,(60001900004786,ARRAY[60002500004656],ST_POINT(-84.8732693,44.5182260,4269),15)
      ,(60001900004786,ARRAY[60002500004656],ST_POINT(-84.8770326,44.5185331,4269),15)
      ,(60001900004786,ARRAY[60002500004656],ST_POINT(-84.8772825,44.5361800,4269),15)
      ,(60001900004774,ARRAY[60002500022545],ST_POINT(-84.7811444,44.6155231,4269),15)
      ,(60001900004774,ARRAY[60002500022545,60001900005473],ST_POINT(-84.7799328,44.6174265,4269),15)
      ,(60001900005473,ARRAY[60002500022545,60001900004774],ST_POINT(-84.7797695,44.6174953,4269),15)
      ,(60001900005473,ARRAY[60002500022545],ST_POINT(-84.7786711,44.6189328,4269),15)
      ,(60002500026476,ARRAY[60001900006776],ST_POINT(-84.7604940,44.6782543,4269),15)
      ,(60002500026476,ARRAY[60001900006776],ST_POINT(-84.7541581,44.6818845,4269),15)
      ,(60001900005437,ARRAY[60002500026476],ST_POINT(-84.7516008,44.6841970,4269),15)
      ,(60001900005437,ARRAY[60002500026476],ST_POINT(-84.7510472,44.6837871,4269),15)
      ,(60001900005437,ARRAY[60002500026476],ST_POINT(-84.7618387,44.6936544,4269),15)
      ,(60001900005437,ARRAY[60002500026476],ST_POINT(-84.7758120,44.7000863,4269),15)
      ,(60001900005437,ARRAY[60002500026476],ST_POINT(-84.7775848,44.7000480,4269),15)
      ,(60001900005437,ARRAY[60002500026476],ST_POINT(-84.7791525,44.6999907,4269),15)
      ,(60001900005437,ARRAY[60002500026476],ST_POINT(-84.7817334,44.7011234,4269),15)
      ,(60001900006113,ARRAY[60002500025117],ST_POINT(-84.7930386,44.7439477,4269),15)
      ,(60001900009289,ARRAY[60002500018213],ST_POINT(-84.7998765,44.9911097,4269),15)
      ,(60001900009289,ARRAY[60002500018213],ST_POINT(-84.8011258,44.9913430,4269),15)
      ,(60001900009289,ARRAY[60002500018213],ST_POINT(-84.8116458,44.9978972,4269),15)
      ,(60001900006475,ARRAY[60002500002295],ST_POINT(-84.7924628,45.1095176,4269),15)
      ,(60001900006475,ARRAY[60002500002295],ST_POINT(-84.7932335,45.1093288,4269),15)
      ,(60001900006475,ARRAY[60002500002295],ST_POINT(-84.8196125,45.1126013,4269),15)
      ,(60001900006475,ARRAY[60002500002295],ST_POINT(-84.8279971,45.1199129,4269),15)
      ,(60001900006475,ARRAY[60002500002070],ST_POINT(-84.8294724,45.1539797,4269),15)
      ,(60001900006475,ARRAY[60002500021148],ST_POINT(-84.8192557,45.1537594,4269),15)
      ,(60001900006475,ARRAY[60002500002070],ST_POINT(-84.8294743,45.1539803,4269),15)
   ) AS t(expand,static,patch,size)
   LOOP
      SELECT
      ST_UNION(
         cipsrv_nhdplus_h.snap_to_common_grid(ST_TRANSFORM(a.shape,5070),'5070',0.001)
      )
      INTO staticgeo
      FROM
      cipsrv_nhdplus_h.nhdpluscatchment a
      WHERE 
      a.nhdplusid = ANY(r.static);
      
      UPDATE cipsrv_nhdplus_h.nhdpluscatchment a
      SET shape = ST_TRANSFORM(
         ST_DIFFERENCE(
             ST_UNION(
                 cipsrv_nhdplus_h.snap_to_common_grid(ST_TRANSFORM(a.shape,5070),'5070',0.001)
                ,cipsrv_nhdplus_h.snap_to_common_grid(ST_BUFFER(ST_TRANSFORM(r.patch,5070),r.size,'quad_segs=2'),'5070',0.001)
             )
            ,staticgeo
          )
         ,4269
      )
      WHERE 
      a.nhdplusid = r.expand;
      
      UPDATE cipsrv_nhdplus_h.nhdpluscatchment a
      SET areasqkm = ST_AREA(ST_TRANSFORM(a.shape,5070))::NUMERIC / 1000000
      WHERE 
      a.nhdplusid = r.expand;
        
   END LOOP;
    
END$$;

