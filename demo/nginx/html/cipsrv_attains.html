<!DOCTYPE html>
<html lang="en" >
   <head>
      <meta charset="UTF-8">
      <title>CIP Service vs ATTAINS</title>
      <link rel='stylesheet' href='https://unpkg.com/leaflet@1.9.4/dist/leaflet.css'>
      <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css'>
      <style>
         #busy {
           position: absolute;
           top: 15%;
           left: 820px;
           z-index: 100;
         }
      </style>
      <script src="config.js"></script>
   </head>
   <body>
      <div id="busy">
         <svg width="57" height="57" viewBox="0 0 57 57" xmlns="http://www.w3.org/2000/svg" stroke="#000">
            <g fill="none" fill-rule="evenodd">
               <g transform="translate(1 1)" stroke-width="2">
                  <circle cx="5" cy="50" r="5">
                     <animate attributeName="cy" begin="0s" dur="2.2s" values="50;5;50;50" calcMode="linear" repeatCount="indefinite" />
                     <animate attributeName="cx" begin="0s" dur="2.2s" values="5;27;49;5" calcMode="linear" repeatCount="indefinite" />
                  </circle>
                  <circle cx="27" cy="5" r="5">
                     <animate attributeName="cy" begin="0s" dur="2.2s" from="5" to="5" values="5;50;50;5" calcMode="linear" repeatCount="indefinite" />
                     <animate attributeName="cx" begin="0s" dur="2.2s" from="27" to="27" values="27;49;5;27" calcMode="linear" repeatCount="indefinite" />
                  </circle>
                  <circle cx="49" cy="50" r="5">
                     <animate attributeName="cy" begin="0s" dur="2.2s" values="50;50;5;50" calcMode="linear" repeatCount="indefinite" />
                     <animate attributeName="cx" from="49" to="49" begin="0s" dur="2.2s" values="49;5;27;49" calcMode="linear" repeatCount="indefinite" />
                  </circle>
               </g>
            </g>
         </svg>
      </div>
      <div id="container" style="width: 1400px;">
         <div id="map" class="map" style="height: 700px; width: 800px; float: left;">
         </div>
         <div id="righty" style="width: 600px; float: left;">
            <div id="top" style="text-align: center;">
               <p>&nbsp;</p>
               <h2 style="margin-top:0px; margin-bottom: 3px;">CIP Service vs ATTAINS</h2>
               <br/>
               <span style="font-family: Arial; font-size: 12px;">First choose an ATTAINS organization:&nbsp;</span>
               <br/>
               <select name="dzATTAINSOrganization" id="dzATTAINSOrganization" style="width:170px; font-family: Arial; font-size: 12px;">
                  <option value=" " SELECTED></option>
                  <option value="AKDECWQ">AK AKDECWQ</option>
                  <option value="21AWIC">AL 21AWIC</option>
                  <option value="ARDEQH2O">AR ARDEQH2O</option>
                  <option value="21AS">AS 21AS</option>
                  <option value="21ARIZ">AZ 21ARIZ</option>
                  <option value="CA_SWRCB">CA CA_SWRCB</option>
                  <option value="CA_BVR">&nbsp;  CA_BVR</option>
                  <option value="HVTEPA">&nbsp;  HVTEPA</option>
                  <option value="21COL001">CO 21COL001</option>
                  <option value="CT_DEP01">CT CT_DEP01</option>
                  <option value="DOEE">DC DOEE</option>
                  <option value="21DELAWQ">DE 21DELAWQ</option>
                  <option value="21FL303D">FL 21FL303D</option>
                  <option value="21GAEPD">GA 21GAEPD</option>
                  <option value="21GUAM">GU 21GUAM</option>
                  <option value="21HI">HI 21HI</option>
                  <option value="21IOWA">IA 21IOWA</option>
                  <option value="IDEQ">ID IDEQ</option>
                  <option value="IL_EPA">IL IL_EPA</option>
                  <option value="21IND">IN 21IND</option>
                  <option value="21KAN001">KS 21KAN001</option>
                  <option value="21KY">KY 21KY</option>
                  <option value="LADEQWPD">LA LADEQWPD</option>
                  <option value="MA_DEP">MA MA_DEP</option>
                  <option value="MDE_EASP">MD MDE_EASP</option>
                  <option value="MEDEP">ME MEDEP</option>
                  <option value="21MICH">MI 21MICH</option>
                  <option value="MNPCA">MN MNPCA</option>
                  <option value="FONDULAC">&nbsp;  FONDULAC</option>
                  <option value="REDLAKE">&nbsp;  REDLAKE</option>
                  <option value="MDNR">MO MDNR</option>
                  <option value="21AQ">MP 21AQ</option>
                  <option value="21MSWQ">MS 21MSWQ</option>
                  <option value="MTDEQ">MT MTDEQ</option>
                  <option value="21NC01WQ">NC 21NC01WQ</option>
                  <option value="21NDHDWQ">ND 21NDHDWQ</option>
                  <option value="21NEB001">NE 21NEB001</option>
                  <option value="11113300">NH 11113300</option>
                  <option value="21NJDEP1">NJ 21NJDEP1</option>
                  <option value="21NMEX">NM 21NMEX</option>
                  <option value="PUEBLO_POJOAQUE">&nbsp;  PUEBLO_POJOAQUE</option>
                  <option value="PUEBLOOFTESUQUE">&nbsp;  PUEBLOOFTESUQUE</option>
                  <option value="PUEBLO_SANTAANA">&nbsp;  PUEBLO_SANTAANA</option>
                  <option value="SANILDEFONSODECP">&nbsp;  SANILDEFONSODECP</option>
                  <option value="21NEV1">NV 21NEV1</option>
                  <option value="21NYDECA">NY 21NYDECA</option>
                  <option value="21OHIO">OH 21OHIO</option>
                  <option value="OKDEQ">OK OKDEQ</option>
                  <option value="CNENVSER">&nbsp;  CNENVSER</option>
                  <option value="CHOCNAT">&nbsp;  CHOCNAT</option>
                  <option value="CPNWATER">&nbsp;  CPNWATER</option>
                  <option value="DELAWARENATION">&nbsp;  DELAWARENATION</option>
                  <option value="KICKAPOO">&nbsp;  KICKAPOO</option>
                  <option value="O_MTRIBE">&nbsp;  O_MTRIBE</option>
                  <option value="SFNOES">&nbsp;  SFNOES</option>
                  <option value="SCEQ">&nbsp;  SCEQ</option>
                  <option value="WNENVDPT">&nbsp;  WNENVDPT</option>
                  <option value="OREGONDEQ">OR OREGONDEQ</option>
                  <option value="21PA">PA 21PA</option>
                  <option value="PR_LAKES">PR PR_LAKES</option>
                  <option value="RIDEM">RI RIDEM</option>
                  <option value="21SC60WQ">SC 21SC60WQ</option>
                  <option value="SDDENR">SD SDDENR</option>
                  <option value="TDECWR">TN TDECWR</option>
                  <option value="TCEQMAIN">TX TCEQMAIN</option>
                  <option value="UTAHDWQ">UT UTAHDWQ</option>
                  <option value="21VASWCB">VA 21VASWCB</option>
                  <option value="USVIST">VI USVIST</option>
                  <option value="1VTDECWQ">VT 1VTDECWQ</option>
                  <option value="WA_ECOLOGY">WA WA_ECOLOGY</option>
                  <option value="WVDEP">WV WVDEP</option>
                  <option value="WIDNR">WI WIDNR</option>
                  <option value="WYDEQ">WY WYDEQ</option>
               </select>
               
               <span style="font-family: Arial; font-size: 10px;">&nbsp;&nbsp;Assmnt Count:</span>
               <input name="dzCount" id="dzCount" value="" style="font-family: Arial; font-size: 12px; width: 30px;" disabled/>
               <br/>
               <br/>
               
               <span style="font-family: Arial; font-size: 12px;">Then choose an assessment identifier:</span>
               <br/>
               
               <select name="dzATTAINSAssessment" id="dzATTAINSAssessment" style="width:250px; font-family: Arial; font-size: 12px;">
                  <option value=" " SELECTED></option>
               </select>
               
               <span style="font-family: Arial; font-size: 10px;">&nbsp;&nbsp;Offset:&nbsp;</span>
               <select name="dzAssessmentOffset" id="dzAssessmentOffset" style="width:60px; font-family: Arial; font-size: 12px;">
                  <option value="0" SELECTED>0</option>
               </select>
               
               <span style="font-family: Arial; font-size: 10px;">&nbsp;&nbsp;</span>
               <input name="dzToggle" id="dzToggle" type="button" value=" " style="font-family: Arial; font-size: 12px;"/>
               <br/>
               <input name="dzBack" id="dzBack" type="button" value="<" style="font-family: Arial; font-size: 12px;"/>
               
               <span style="font-family: Arial; font-size: 10px;">&nbsp;&nbsp;Catchment Count:</span>
               <input name="dzCatCount" id="dzCatCount" value="" style="font-family: Arial; font-size: 10px; width: 30px;" disabled/>
               
               <span style="font-family: Arial; font-size: 10px;">&nbsp;&nbsp;&nbsp;Catchment Area:</span>
               <input name="dzMeas" id="dzMeas" value="" style="font-family: Arial; font-size: 10px; width: 30px;" disabled/>
               
               <span style="font-family: Arial; font-size: 10px;">SqKm&nbsp;&nbsp;</span>
               <input name="dzForward" id="dzForward" type="button" value=">" style="font-family: Arial; font-size: 12px;"/>
               <br/>
               
               <textarea name="dzATTAINSPoints" id="dzATTAINSPoints" style="width: 500px; margin-left: auto; display: none;" rows="3"></textarea>
               <textarea name="dzATTAINSLines"  id="dzATTAINSLines"  style="width: 500px; margin-left: auto; display: none;" rows="3"></textarea>
               <textarea name="dzATTAINSAreas"  id="dzATTAINSAreas"  style="width: 500px; margin-left: auto; display: none;" rows="3"></textarea>
               <table border="1" id="dzATTAINSCats" name="dzATTAINSCats" style="border-collapse: collapse; border: 1px solid black; width: 505px; margin-left: auto; display: none;">
                  <thead>
                     <tr>
                        <th style="font-family: Arial; font-size: 12px; padding: 5px;">&nbsp;</th>
                        <th style="font-family: Arial; font-size: 12px; padding: 5px;">catchmentstatecode</th>
                        <th style="font-family: Arial; font-size: 12px; padding: 5px;">nhdplusid</th>
                        <th style="font-family: Arial; font-size: 12px; padding: 5px;">area (sqkm)</th>
                     </tr>
                  </thead>
                  <tbody>
                  </tbody>
               </table>
               <br/>
               
               <span style="font-family: Arial; font-size: 11px;">NHDPlus Version:&nbsp;</span>
               <select name="dzNHDPlusVersion" id="dzNHDPlusVersion" style="width:170px; font-family: Arial; font-size: 12px;">
                  <option value="nhdplus_m" SELECTED>Medium Resolution</option>
                  <option value="nhdplus_h">High Resolution</option>
               </select>
               <br/>
               <br/>
               
               <table border="0" align="center">
               <tr>
               <td valign="top">
               <span style="font-family: Arial; font-size: 12px;">Clip Geometry By:&nbsp;</span>
               </td>
               <td>
                  <select name="dzClipGeometry" id="dzClipGeometry" style="font-family: Arial; font-size: 11px; width:310px" multiple="multiple" size="4">
                  </select>
               </td>
               <td>
                  <select name="dzGeometryClipStage" id="dzGeometryClipStage" style="font-family: Arial; font-size: 11px;">
                     <option value="BEFORE" SELECTED>Before</option>
                     <option value="AFTER">After</option>
                  </select>
               </td>
               </tr>
               </table>
               
               <table border="0" align="center">
               <tr>
               <td valign="top">
               <span style="font-family: Arial; font-size: 12px;">Catchment Filters:&nbsp;</span>
               </td>
               <td>
               <select name="dzCatchmentFilters" id="dzCatchmentFilters" style="font-family: Arial; font-size: 11px; width:200px" multiple="multiple" size="4"> 
               </select>
               <td/>
               <tr/>
               </table>
               
               <table border="0" align="center">
               <tr>
               <td valign="top" rowspan="2">
               <span style="font-family: Arial; font-size: 11px;">Default Indexing Methods:&nbsp;</span>
               </td>
               <td>
               <span style="font-family: Arial; font-size: 11px;">Points:</span><br/>
               <select name="dzDefaultPointIndexingMethod" id="dzDefaultPointIndexingMethod" style="width:120px; font-family: Arial; font-size: 11px;">
                  <option value="point_simple" SELECTED>Point - Simple</option>
               </select>
               </td>
               <td width="150px;">
               <span style="font-family: Arial; font-size: 11px;">Lines:</span><br/>
               <select name="dzDefaultLineIndexingMethod" id="dzDefaultLineIndexingMethod" style="width:120px; font-family: Arial; font-size: 11px;">
                  <option value="line_simple" SELECTED>Line - Simple</option>
                  <option value="line_levelpath">Line - LevelPath</option>
               </select>
               </td>
               </tr>
               <tr>
               <td>
               <span style="font-family: Arial; font-size: 11px;">Rings:</span><br/>
               <select name="dzDefaultRingIndexingMethod" id="dzDefaultRingIndexingMethod" style="width:120px; font-family: Arial; font-size: 11px;">
                  <option value="area_simple" SELECTED>Area - Simple</option>
                  <option value="area_centroid">Area - Centroid</option>
                  <option value="area_artpath">Area - Artifical Paths</option>
                  <option value="treat_as_lines">Treat Rings as Lines</option>
               </select>
               </td>
               <td>
               <span style="font-family: Arial; font-size: 11px;">Areas:</span><br/>
               <select name="dzDefaultAreaIndexingMethod" id="dzDefaultAreaIndexingMethod" style="width:120px; font-family: Arial; font-size: 11px;">
                  <option value="area_simple">Area - Simple</option>
                  <option value="area_centroid">Area - Centroid</option>
                  <option value="area_artpath" SELECTED>Area - Artifical Paths</option>
               </select>
               </td>
               </tr>
               </table>
               
               <br/>
               <span style="font-family: Arial; font-size: 11px;">&nbsp;&nbsp;&nbsp; Line Thold:</span>
               <input name="dzLineThreasholdPerc" id="dzLineThreasholdPerc" type="text" class="text" style="display:inline; width:25px; font-family: Arial; font-size: 11px;" value="10" />
               <span style="font-family: Arial; font-size: 11px;"> %</span>
               <br/>
               <span style="font-family: Arial; font-size: 11px;">&nbsp;&nbsp;&nbsp; Ring Area Catchment Thold:</span>
               <input name="dzRingCatThreasholdPerc" id="dzRingCatThreasholdPerc" type="text" class="text" style="display:inline; width:25px; font-family: Arial; font-size: 11px;" value="50" />
               <span style="font-family: Arial; font-size: 11px;"> %</span>
               <span style="font-family: Arial; font-size: 11px;">&nbsp;&nbsp;&nbsp; Ring Area Event Thold:</span>
               <input name="dzRingEvtThreasholdPerc" id="dzRingEvtThreasholdPerc" type="text" class="text" style="display:inline; width:25px; font-family: Arial; font-size: 11px;" value="1" />
               <span style="font-family: Arial; font-size: 11px;"> %</span>
               <br/>
               <span style="font-family: Arial; font-size: 11px;">&nbsp;&nbsp;&nbsp; Area Catchment Thold:</span>
               <input name="dzCatThreasholdPerc" id="dzCatThreasholdPerc" type="text" class="text" style="display:inline; width:25px; font-family: Arial; font-size: 11px;" value="50" />
               <span style="font-family: Arial; font-size: 11px;"> %</span>
               <span style="font-family: Arial; font-size: 11px;">&nbsp;&nbsp;&nbsp; Area Event Thold:</span>
               <input name="dzEvtThreasholdPerc" id="dzEvtThreasholdPerc" type="text" class="text" style="display:inline; width:25px; font-family: Arial; font-size: 11px;" value="1" />
               <span style="font-family: Arial; font-size: 11px;"> %</span>
               <br/>
               <br/>
               <span style="font-family: Arial; font-size: 11px;">Show Catchments:</span>
               <input name="dzShowCatchments" id="dzShowCatchments" type="checkbox" CHECKED>
               &nbsp;&nbsp;&nbsp;&nbsp;
               <span style="font-family: Arial; font-size: 11px;">Show Flowlines:</span>
               <input name="dzShowFlowlines" id="dzShowFlowlines" type="checkbox">
               &nbsp;&nbsp;&nbsp;&nbsp;
               <span style="font-family: Arial; font-size: 11px;">Show HUC12s:</span>
               <input name="dzShowHUC12s" id="dzShowHUC12s" type="checkbox" DISABLED>
               <br/>
               <br/>
               <input type="button" onclick="run_service();" value="Start Search" id="dz_run_service" />&nbsp;
               <input type="button" onclick="dz_clear_full();" value="Clear" name="dz_clear" id="dz_clear" />&nbsp;
            </div>
            <br/>
            <br/>
            <div id="output" style="text-align: center"></div>
         </div>
      </div>
      <script src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'></script>
      <script src='https://unpkg.com/esri-leaflet@3.0.14/dist/esri-leaflet.js'></script>
      <script src='https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js'></script>
      <script>
   document.getElementById("dz_run_service").disabled = true;
   document.getElementById("busy").style.visibility = "hidden";
   z1 = document.getElementById("dzATTAINSOrganization");
   z1.onchange = function(){select_org(z1.value);};
   z2 = document.getElementById("dzATTAINSAssessment");
   z2.onchange = function(){select_ass(z2.value);};
   z3 = document.getElementById("dzAssessmentOffset");
   z3.onchange = function(){select_off(z3.value);};
   z4 = document.getElementById("dzToggle");
   z4.onclick = function(){select_toggle();};
   z5 = document.getElementById("dzForward");
   z5.onclick = function(){select_forward();};
   z6 = document.getElementById("dzBack");
   z6.onclick = function(){select_back();};

   var zoom_cache = {};
   var domainsLoaded = false;
   
   // Try to load the domains first time
   getDomains(); 
   
   var lazy_org;
   var lazy_auid;
   var nochange = false;
   var waiter;

   var map = L.map("map").setView([46.874626,-96.782341],12);
   mapLink = '<a href="http://openstreetmap.org">OpenStreetMap</a>';

   basemap = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "Map data &copy; " + mapLink,
      maxZoom: 18
   });
   basemap.addTo(map);

   var drawnItems = new L.FeatureGroup().addTo(map);
   var drawControl = new L.Control.Draw({
      draw: {
         polygon: true,
         polyline: true,
         rectangle: false,
         circle: false,
         marker: true,
         circlemarker: false
      },
      edit: {
         featureGroup: drawnItems,
         edit: false,
         remove: true
      }
   });
   
   var ATTAINS_points     = L.geoJson().addTo(map);
   var ATTAINS_lines      = L.geoJson().addTo(map);
   var ATTAINS_areas      = L.geoJson().addTo(map);
   var ATTAINS_catchments = L.geoJson().addTo(map);
   
   // Check for domains hit a second time 
   if (! domainsLoaded ) {
      const date = Date.now();
      let currentDate = null;
      do {
         currentDate = Date.now();
      } while (currentDate - date < 20 );
      
      if (! domainsLoaded ) {
         getDomains();
      }
   }
   
   var indexed_points = L.geoJson(null,{
      onEachFeature: function (f,l) {
         l.bindPopup('<b>Indexed Event</b><br/><pre>' + JSON.stringify(f.properties,null,' ').replace(/[\{\}"]/g,'') + '</pre>');
      }
   }).addTo(map);
   
   var indexed_lines = L.geoJson(null,{
      onEachFeature: function (f,l) {
         l.bindPopup('<b>Indexed Event</b><br/><pre>' + JSON.stringify(f.properties,null,' ').replace(/[\{\}"]/g,'') + '</pre>');
      }
   }).addTo(map);
   
   var indexed_areas = L.geoJson(null,{
      onEachFeature: function (f,l) {
         l.bindPopup('<b>Indexed Event</b><br/><pre>' + JSON.stringify(f.properties,null,' ').replace(/[\{\}"]/g,'') + '</pre>');
      }
   }).addTo(map);

   var indexed_catchments = L.geoJson(null,{
      onEachFeature: function (f,l) {
         l.bindPopup('<b>Indexed Catchment</b><br/><pre>' + JSON.stringify(f.properties,null,' ').replace(/[\{\}"]/g,'') + '</pre>');
      }
   }).addTo(map);

   var catchment_flowlines = L.geoJson(null,{
      onEachFeature: function (f,l) {
         l.bindPopup('<b>NHD Flowline</b><br/><pre>' + JSON.stringify(f.properties,null,' ').replace(/[\{\}"]/g,'') + '</pre>');
      }
   }).addTo(map);

   var xwalked_huc12s = L.geoJson(null,{
      onEachFeature: function (f,l) {
         l.bindPopup('<b>Indexed HUC12s</b><br/><<pre>' + JSON.stringify(f.properties,null,' ').replace(/[\{\}"]/g,'') + '</pre>');
      }
   }).addTo(map);

   var dummy_zoomer = L.geoJson().addTo(map);

   var layer_items = {
       "ATTAINS Points":      ATTAINS_points
      ,"ATTAINS Lines":       ATTAINS_lines
      ,"ATTAINS Areas":       ATTAINS_areas
      ,"ATTAINS Catchments":  ATTAINS_catchments
      ,"Indexed Points":      indexed_points
      ,"Indexed Lines":       indexed_lines
      ,"Indexed Areas":       indexed_areas
      ,"Indexed Catchments":  indexed_catchments
      ,"Catchment Flowlines": catchment_flowlines
      ,"XWalked HUC12s":      xwalked_huc12s
   };
   L.control.layers(null, layer_items).addTo(map);
   
   // check for domains a third time
   if (! domainsLoaded ) {
      const date = Date.now();
      let currentDate = null;
      do {
         currentDate = Date.now();
      } while (currentDate - date < 200 );
      
      if (! domainsLoaded ) {
         getDomains();
      }
   }

   function run_service() {
      dz_clear();
      busy_on();

      var jpoints = null;
      var points  = document.getElementById("dzATTAINSPoints").value;
      if (points == null || points == "" || points == " " ) {
         null;
      } else {
         jpoints = JSON.parse(points);
      }
      
      var jlines = null;
      var lines = document.getElementById("dzATTAINSLines").value;
      if (lines == null || lines == "" || lines == " " ) {
         null;
      } else {
         jlines = JSON.parse(lines);
      }
      
      var jareas = null;
      var areas   = document.getElementById("dzATTAINSAreas").value;
      if (areas == null || areas == "" || areas == " " ) {
         null;
      } else {
         jareas = JSON.parse(areas);
      }
      
      var geomc  = document.getElementById("dzGeometryClip");
      var geoms  = document.getElementById("dzGeometryClipStage");
      var catfl  = document.getElementById("dzCatchmentFilters");
      
      var pnhdv  = document.getElementById("dzNHDPlusVersion");
      var pointm = document.getElementById("dzDefaultPointIndexingMethod");
      var linem  = document.getElementById("dzDefaultLineIndexingMethod");
      var ringm  = document.getElementById("dzDefaultRingIndexingMethod");
      var aream  = document.getElementById("dzDefaultAreaIndexingMethod");
      
      var data = {
          "points":                        jpoints
         ,"lines":                         jlines
         ,"areas":                         jareas
         
         ,"geometry_clip":                 get_mselect_values(geomc)
         ,"geometry_clip_stage":           get_select_values(geoms)
         ,"catchment_filter":              get_mselect_values(catfl)
         ,"nhdplus_version":               get_select_values(pnhdv)
         ,"wbd_version":                   null
         
         ,"default_point_indexing_method":  get_select_values(pointm)
         
         ,"default_line_indexing_method":   get_select_values(linem)
         ,"default_line_threshold":         document.getElementById("dzLineThreasholdPerc").value
         
         ,"default_ring_indexing_method":   get_select_values(ringm)
         ,"default_ring_areacat_threshold": document.getElementById("dzRingCatThreasholdPerc").value
         ,"default_ring_areaevt_threshold": document.getElementById("dzRingEvtThreasholdPerc").value
         
         ,"default_area_indexing_method":   get_select_values(aream)
         ,"default_areacat_threshold":      document.getElementById("dzCatThreasholdPerc").value
         ,"default_areaevt_threshold":      document.getElementById("dzEvtThreasholdPerc").value
         
         ,"return_indexed_features":       true
         ,"return_indexed_collection":     false
         ,"return_catchment_geometry":     document.getElementById("dzShowCatchments").checked
         ,"return_flowlines":              document.getElementById("dzShowFlowlines").checked
         ,"return_flowline_geometry":      true
         ,"return_huc12s":                 document.getElementById("dzShowHUC12s").checked
      };
      
      httpPost(
         build_api() + "cipsrv_index",
         data,
         get_response
      );

   }

   function httpPost(url,data,callback) {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open("POST",url,true);
      xmlHttp.setRequestHeader('Content-Type','application/json');
      xmlHttp.responseType = 'json';
      xmlHttp.onreadystatechange = function() {
         if(xmlHttp.readyState === 4) {
            if(xmlHttp.status === 200) {
               response = xmlHttp.response;
               callback(null,response);
            } else {
               callback(xmlHttp.statusText,null);
            }
         }
      };
      xmlHttp.send(JSON.stringify(data));
   }
   
   function getDomains() {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.onreadystatechange = function() {
         if (xmlHttp.readyState === 4) { // request is done
            if (xmlHttp.status === 200) { // successfully
               domainsLoaded = true;
               
               var obj = JSON.parse(xmlHttp.responseText);
               var states = obj["states"];
               var tribes = obj["tribes"];
               
               var catfilter = document.getElementById("dzCatchmentFilters");
               var load = '<option value="TRIBAL">Tribal Only</option>';
               load    += '<option value="NOTRIBAL">No Tribal</option>';
               for (let i=0; i < states.length; i++) {
                  load += '<option value="' + states[i].stusps + '">' + states[i].name + '</option>';
               }
               catfilter.innerHTML = load;
               var clipgeo = document.getElementById("dzClipGeometry");
               load = '';
               for (let i=0; i < states.length; i++) {
                  load += '<option value="USPS:' + states[i].stusps + '">' + states[i].name + '</option>';
               }
               for (let i=0; i < tribes.length; i++) {
                  if (tribes[i].has_reservation_lands && tribes[i].has_trust_lands) {
                     load += '<option value="GEOID_STEM:' + tribes[i].aiannhns_stem + '">' + tribes[i].aiannhns_namelsad + '</option>';
                     load += '<option value="GEOID_STEM:' + tribes[i].aiannhns_stem + ':R">' + tribes[i].aiannhns_namelsad + ' (Reservation Lands Only)</option>';
                     load += '<option value="GEOID_STEM:' + tribes[i].aiannhns_stem + ':T">' + tribes[i].aiannhns_namelsad + ' (Trust Lands Only)</option>';
                  } else if (tribes[i].has_reservation_lands && ! tribes[i].has_trust_lands) {
                     load += '<option value="GEOID_STEM:' + tribes[i].aiannhns_stem + ':R">' + tribes[i].aiannhns_namelsad + ' (Reservation Lands Only)</option>';
                  } else if (! tribes[i].has_reservation_lands && tribes[i].has_trust_lands) {
                     load += '<option value="GEOID_STEM:' + tribes[i].aiannhns_stem + ':T">' + tribes[i].aiannhns_namelsad + ' (Trust Lands Only)</option>';
                  }
               }
               clipgeo.innerHTML = load;
               return obj;
            }
         }
      };
      
      var url = build_api() + "cipsrv_domains"
      xmlHttp.open('GET',url);
      xmlHttp.send();
   }      
   
   function get_select_values(select){
      var result = null;
      
      if ( select == null ) {
         return result;
      }
      
      if ( select.options == null ) {
         return result;
      }
      
      if ( select.selectedIndex == null ) {
         return result;
      }
      
      return select.options[select.selectedIndex].value;
   
   }
   
   function get_mselect_values(select){
      var result = [];
      var options = select && select.options;
      var opt;
      
      if ( options == null ) {
         return result;
      }

      for (var i=0, iLen=options.length; i<iLen; i++) {
         opt = options[i];

         if (opt.selected) {
            result.push(opt.value || opt.text);
         }
      }
      return result;
   }

   function get_response(error,response) {
      busy_off();

      if (error) {
         document.getElementById("output").innerHTML = "<P>" + error + "</P>";
         return false;
      } else if (response == null) {
         document.getElementById("output").innerHTML = "<P>No response from service.</P>";
         return false;
      } else if (response.return_code != 0) {
         document.getElementById("output").innerHTML = "<P>" + response.status_message + "</P>";
         return false;
      } else if (response.catchment_count == 0) {
         document.getElementById("output").innerHTML = "<P>No catchments indexed.</P>";
      }

      if (response.indexed_points !== null && response.indexed_points.features[0].geometry.type !== null) {
         indexed_points.addData(response.indexed_points).setStyle({
             "color":       "#808080"
            ,"opacity":     .80
            ,"fillColor":   "#808080"
            ,"fillOpacity": .10
         });
      }
      
      if (response.indexed_lines !== null && response.indexed_lines.features[0].geometry.type !== null) {
         indexed_lines.addData(response.indexed_lines).setStyle({
             "color":       "#808080"
            ,"opacity":     .80
            ,"fillColor":   "#808080"
            ,"fillOpacity": .10
         });
      }
      
      if (response.indexed_areas !== null && response.indexed_areas.features[0].geometry.type !== null) {
         indexed_areas.addData(response.indexed_areas).setStyle({
             "color":       "#808080"
            ,"opacity":     .80
            ,"fillColor":   "#808080"
            ,"fillOpacity": .10
         });
      }

      if (response.catchments !== null && response.catchments.features[0].geometry.type !== null) {
         indexed_catchments.addData(response.catchments).setStyle({
             "color":       "#FF6600"
            ,"fillColor":   "#FF6600"
         });
         
      }
      
      if (response.flowlines !== null && response.flowlines.features[0].geometry.type !== null) {
         catchment_flowlines.addData(response.flowlines).setStyle({
             "color":       "#003399"
            ,"opacity":     .80
         });
      }
      
      if (response.huc12s !== null && response.huc12s.features[0].geometry.type !== null) {
         xwalked_huc12s.addData(response.huc12s).setStyle({
             "color":       "#CC33FF"
            ,"fillColor":   "#CC33FF"
         });
      }
      
      if (response.huc12s !== null && response.huc12s.features[0].geometry.type !== null) {
         map.fitBounds(indexed_huc12s.getBounds(), {
            maxZoom: 16
         });
         
      } else if (response.catchments !== null && response.catchments.features[0].geometry.type !== null) {
         map.fitBounds(indexed_catchments.getBounds(), {
            maxZoom: 16
         });
      }    

      zoom_cache = {};
      
      if (response.catchments !== null ) {
         var attains_count = Number(document.getElementById("dzCatCount").value);
         var attains_meas  = Number(document.getElementById("dzMeas").value);

         var color = " color: red; font-weight: bold;";
         if (response.catchment_count == attains_count && roundNumber(response.catchment_areasqkm,2) == attains_meas.toFixed(2)) {
            color = " color: green; font-weight: bold;";
         }

         tbl_beg = '<TABLE border="1" style="margin: 0 auto; border-collapse: collapse; width: 400px; padding: 7px;">'
                 + '<TR>'
                 + '<TH colspan="5" style="font-family: Arial; font-size: 14px;' + color + '">' + response.catchment_count + ' Catchments Indexed - ' + roundNumber(response.catchment_areasqkm,3) + ' SqKm</TH>'
                 + '<TR>'
                 + '<TH style="font-family: Arial; font-size: 14px;">Zoom</TH>'
                 + '<TH style="font-family: Arial; font-size: 14px;">State</TH>'
                 + '<TH style="font-family: Arial; font-size: 14px;">NHDPlusID</TH>'
                 + '<TH style="font-family: Arial; font-size: 14px;">Area SqKm</TH>'
                 + '<TH style="font-family: Arial; font-size: 14px;">Tribal SqKm</TH>'
                 + '</TR>';
         tbl_end = '</TABLE>';

         tbl_cnt = '';
         for (var i = 0; i < response.catchments.features.length; i++) {
            tbl_cnt += '<TR>'
                    +  '<TD style="font-family: Arial; font-size: 14px;">';

            if (response.catchments.features[0].geometry.type !== null) {
               tbl_cnt += '<input type="button" value="' + (i+1) + '" onclick="zoom_to_catchment(\'' + response.catchments.features[i].properties.catchmentstatecode + response.catchments.features[i].properties.nhdplusid + '\');"/>';
               zoom_cache[response.catchments.features[i].properties.catchmentstatecode + response.catchments.features[i].properties.nhdplusid] = response.catchments.features[i].geometry;
            } else {
               tbl_cnt += (i+1);
            }

            tcat = roundNumber(response.catchments.features[i].properties.istribal_areasqkm,4);
            if (tcat == null ) {
               stcat = '';
            } else {
               stcat = tcat.toString();
            }
            
            tbl_cnt += '</TD>'
                    +  '<TD style="font-family: Arial; font-size: 14px;">' + response.catchments.features[i].properties.catchmentstatecode + '</TD>'
                    +  '<TD style="font-family: Arial; font-size: 14px;">' + response.catchments.features[i].properties.nhdplusid + '</TD>'
                    +  '<TD style="font-family: Arial; font-size: 14px;">' + roundNumber(response.catchments.features[i].properties.areasqkm,4) + '</TD>'
                    +  '<TD style="font-family: Arial; font-size: 14px;">' + stcat + '</TD>'
                    +  '</TR>';
            }

         document.getElementById("output").innerHTML = tbl_beg + tbl_cnt + tbl_end;
         
      }

   }

   function zoom_to_catchment(id) {
      dummy_zoomer.clearLayers();
      dummy_zoomer.addData(zoom_cache[id]).setStyle({
          "opacity":     0
         ,"fillOpacity": 0
      });
      map.fitBounds(dummy_zoomer.getBounds(), {
         maxZoom: 16
      });
      return true;
   }
   
   function dz_clear() {
      document.getElementById("output").innerHTML = "";
      indexed_points.clearLayers();
      indexed_lines.clearLayers();
      indexed_areas.clearLayers();
      indexed_catchments.clearLayers();
      catchment_flowlines.clearLayers();
      xwalked_huc12s.clearLayers();
      busy_off();
      
      no_change = false;
   }

   function dz_clear_full() {
      dz_clear()
      no_change = true;
      
      document.getElementById("dzATTAINSAssessment").innerHTML = '<option value=" " SELECTED></option>';
      document.getElementById("dzAssessmentOffset").innerHTML  = '<option value="0" SELECTED>0</option>';
      document.getElementById("dzATTAINSOrganization").value = " ";
      document.getElementById("dzMeas").value = "";
      document.getElementById("dzCatCount").value = "";
      document.getElementById('dzATTAINSCats').getElementsByTagName('tbody')[0].innerHTML = "";
      
      no_change = false;
   }

   function busy_on() {
      document.getElementById("busy").style.visibility = "visible";
      document.body.style.cursor = "wait";
      document.getElementById("dz_run_service").disabled = true;
   }

   function busy_off() {
      document.getElementById("busy").style.visibility = "hidden";
      document.body.style.cursor = "auto";
      document.getElementById("dz_run_service").disabled = false;
   }
   
   function select_org(val) {

      if (val == "" || val == " " || val == null) {
         no_change = true;
         document.getElementById("dzATTAINSAssessment").innerHTML = '<option value=" " SELECTED></option>';
         document.getElementById("dzAssessmentOffset").innerHTML  = '<option value="0" SELECTED>0</option>';
         
         no_change = false;
         return true;
      }
      document.getElementById("output").innerHTML = "";
      
      var state;
      var def_point;
      var def_line;
      var def_area;
      var def_line_threshold;
      var def_areaevt_threshold;
      var def_areacat_threshold;
      
      if (val == "AKDECWQ" ) {
         state = "AK";
      } else if (val == "21AWIC") {
         state = "AL";
      } else if (val == "ARDEQH2O") {
         state = "AR";
      } else if (val == "21AS") {
         state = "AS";
      } else if (val == "21ARIZ") {
         state = "AZ";
      } else if (val == "CA_SWRCB") {
         state = "CA";
      } else if (val == "CA_BVR") {
         state = "CA";
      } else if (val == "HVTEPA") {
         state = "CA";
      } else if (val == "21COL001") {
         state = "CO";
      } else if (val == "CT_DEP01") {
         state = "CT";
      } else if (val == "DOEE") {
         state = "DC";
      } else if (val == "21DELAWQ") {
         state = "DE";
      } else if (val == "21FL303D") {
         state = "FL";
      } else if (val == "21GAEPD") {
         state = "GA";
      } else if (val == "21GUAM") {
         state = "GU";
      } else if (val == "21HI") {
         state = "HI";
      } else if (val == "21IOWA") {
         state = "IA";
      } else if (val == "IDEQ") {
         state = "ID";
      } else if (val == "IL_EPA") {
         state = "IL";
      } else if (val == "21IND") {
         state = "IN";
      } else if (val == "21KAN001") {
         state = "KS";
      } else if (val == "21KY") {
         state = "KY";
      } else if (val == "LADEQWPD") {
         state = "LA";
      } else if (val == "MA_DEP") {
         state = "MA";
      } else if (val == "MDE_EASP") {
         state = "MD";
      } else if (val == "MEDEP") {
         state = "ME";
      } else if (val == "21MICH") {
         state = "MI";
      } else if (val == "MNPCA") {
         state = "MN";
      } else if (val == "FONDULAC") {
         state = "MN";
      } else if (val == "REDLAKE") {
         state = "MN";
      } else if (val == "MDNR") {
         state = "MO";
      } else if (val == "21AQ") {
         state = "MP";
      } else if (val == "21MSWQ") {
         state = "MS";
      } else if (val == "MTDEQ") {
         state = "MT";
      } else if (val == "21NC01WQ") {
         state = "NC";
      } else if (val == "21NDHDWQ") {
         state = "ND";
      } else if (val == "21NEB001") {
         state = "NE";
      } else if (val == "11113300") {
         state = "NH";
      } else if (val == "21NJDEP1") {
         state = "NJ";
      } else if (val == "21NMEX") {
         state = "NM";
      } else if (val == "PUEBLO_POJOAQUE") {
         state = "NM"; 
      } else if (val == "PUEBLOOFTESUQUE") {
         state = "NM"; 
      } else if (val == "PUEBLO_SANTAANA") {
         state = "NM"; 
      } else if (val == "SANILDEFONSODECP") {
         state = "NM";
      } else if (val == "21NEV1") {
         state = "NV";
      } else if (val == "21NYDECA") {
         state = "NY";
      } else if (val == "21OHIO") {
         state = "OH";
      } else if (val == "OKDEQ") {
         state = "OK";
      } else if (val == "CNENVSER") {
         state = "OK";
      } else if (val == "CHOCNAT") {
         state = "OK";
      } else if (val == "CPNWATER") {
         state = "OK";
      } else if (val == "DELAWARENATION") {
         state = "OK";  
      } else if (val == "KICKAPOO") {
         state = "OK";
      } else if (val == "O_MTRIBE") {
         state = "OK";
      } else if (val == "SFNOES") {
         state = "OK";
      } else if (val == "SCEQ") {
         state = "OK";
      } else if (val == "WNENVDPT") {
         state = "OK";
      } else if (val == "OREGONDEQ") {
         state = "OR";
      } else if (val == "21PA") {
         state = "PA";
      } else if (val == "PR_LAKES") {
         state = "PR";
      } else if (val == "RIDEM") {
         state = "RI";
      } else if (val == "21SC60WQ") {
         state = "SC";
      } else if (val == "SDDENR") {
         state = "SD";
      } else if (val == "TDECWR") {
         state = "TN";
      } else if (val == "TCEQMAIN") {
         state = "TX";
      } else if (val == "UTAHDWQ") {
         state = "UT";
      } else if (val == "21VASWCB") {
         state = "VA";
      } else if (val == "USVIST") {
         state = "VI";
      } else if (val == "1VTDECWQ") {
         state = "VT";
      } else if (val == "WA_ECOLOGY") {
         state = "WA";
      } else if (val == "WVDEP") {
         state = "WV";
      } else if (val == "WIDNR") {
         state = "WI";
      } else if (val == "WYDEQ") {
         state = "WY";
      }
      
      if (state !== null && state !== undefined) {
         document.getElementById("dzCatchmentFilters").value = state;
      }
      
      if (def_point !== null && def_point !== undefined) {
         document.getElementById("dzDefaultPointIndexingMethod").value = def_point;
      }
      
      if (def_line !== null && def_line !== undefined) {
         document.getElementById("dzDefaultLineIndexingMethod").value = def_line;
      }
      
      if (def_area !== null && def_area !== undefined) {
         document.getElementById("dzDefaultAreaIndexingMethod").value = def_area;
      }
      
      if (def_line_threshold !== null && def_line_threshold !== undefined) {
         document.getElementById("dzLineThreasholdPerc").value = def_line_threshold;
      }
      
      if (def_areaevt_threshold !== null && def_areaevt_threshold !== undefined) {
         document.getElementById("dzEvtThreasholdPerc").value = def_areaevt_threshold;
      }
      
      if (def_areacat_threshold !== null && def_areacat_threshold !== undefined) {
         document.getElementById("dzCatThreasholdPerc").value = def_areacat_threshold;
      }
      
      busy_on();
      lazy_org = val;
      
      var data = {
          "where":                "organizationid = '" + val + "' and (point_count > 0 or line_count > 0 or area_count > 0)"
         ,"returnGeometry":       "false"
         ,"returnIdsOnly":        "false"
         ,"returnCountOnly":      "true"
         ,"returnDistinctValues": "false"
      };
        
      L.esri.get(
          'https://gispub.epa.gov/arcgis/rest/services/OW/ATTAINS_Assessment/MapServer/4/query'
         ,data
         ,select_org_count
      );
      
   }
   
   function select_org_count(error,response) {
      
      if (error) {
         document.getElementById("output").innerHTML = "<P>" + error + "</P>";
         return false;
      }
      
      no_change = true;
      document.getElementById("dzAssessmentOffset").innerHTML  = '<option value="0" SELECTED>0</option>';
      for (var i = 2000; i < 220000; i=i+2000) {
         if (response.count > i) {
            document.getElementById("dzAssessmentOffset").innerHTML += '<option value="' + i + '">' + i + '</option>';
         }
      }
      no_change = false;
      
      document.getElementById("dzCount").value = response.count;
      var roff = document.getElementById("dzAssessmentOffset");
      
      if (response.count == 0) {
         busy_off();
         no_change = true;
         document.getElementById("dz_run_service").disabled = true;
         ATTAINS_points.clearLayers();
         ATTAINS_lines.clearLayers();
         ATTAINS_areas.clearLayers();
         ATTAINS_catchments.clearLayers();
         document.getElementById("dzATTAINSAssessment").innerHTML = '<option value=" " SELECTED></option>';
         document.getElementById("dzAssessmentOffset").innerHTML  = '<option value="0" SELECTED>0</option>';
         
         document.getElementById("dzMeas").value = "";
         document.getElementById("dzCatCount").value = "";
         
         no_change = false;
         return true;
      
      }

      var data = {
          "where":                "organizationid = '" + lazy_org + "' and (point_count > 0 or line_count > 0 or area_count > 0)"
         ,"outfields":            "assessmentunitidentifier,reportingcycle,point_count,line_count,area_count"
         ,"returnGeometry":       "false"
         ,"returnIdsOnly":        "false"
         ,"returnCountOnly":      "false"
         ,"returnDistinctValues": "false"
         ,"orderByFields":        "assessmentunitidentifier"
         ,"resultOffset":         roff.options[roff.selectedIndex].value
      };
        
      L.esri.get(
          'https://gispub.epa.gov/arcgis/rest/services/OW/ATTAINS_Assessment/MapServer/4/query'
         ,data
         ,select_org_resp
      );
      
   }
   
   function select_org_resp(error,response) {
      
      if (error) {
         document.getElementById("output").innerHTML = "<P>" + error + "</P>";
         return false;
      }
      
      if (response.features.length > 0) {
         var v = '';
         for (var i = 0; i < response.features.length; i++) {
            var auid = response.features[i].attributes.assessmentunitidentifier;
            var rcyc = response.features[i].attributes.reportingcycle;
            var pcnt = response.features[i].attributes.point_count;
            var lcnt = response.features[i].attributes.line_count;
            var acnt = response.features[i].attributes.area_count;
            v += '<option value="' + auid + ',' + pcnt + ',' + lcnt + ',' + acnt + '">' + rcyc + ' ' + auid + '</option>'
         
         }
         document.getElementById("dzATTAINSAssessment").innerHTML = v;
         
      }
      
      var item = document.getElementById("dzATTAINSAssessment");
      var val  = item.options[item.selectedIndex].value;
      if ( val == "" || val == " " || val == null) {
         busy_off();
         no_change = true;
         document.getElementById("dz_run_service").disabled = true;
         ATTAINS_event.clearLayers();
         ATTAINS_catchments.clearLayers();
         document.getElementById("dzATTAINSAssessment").innerHTML = '<option value=" " SELECTED></option>';
         document.getElementById("dzAssessmentOffset").innerHTML  = '<option value="0" SELECTED>0</option>';
         document.getElementById("dzMeas").value = "";
         document.getElementById("dzCatCount").value = "";
         
         no_change = false;
         return true;
      } else {
         select_ass(val);
      }
      
   }
   
   function select_ass(val) {
      
      if (no_change == true) {
         return True;
      }
      
      busy_on();
      
      var items = val.split(',');
      var auid = items[0];
      var pcnt = items[1];
      var lcnt = items[2];
      var acnt = items[3];
      
      lazy_auid = auid;
      document.getElementById("output").innerHTML = "";
      ATTAINS_areas.clearLayers();
      ATTAINS_lines.clearLayers();
      ATTAINS_points.clearLayers();
      ATTAINS_catchments.clearLayers();
      dz_clear();
      waiter = 1;
      
      if ( acnt > 0 ) {
         waiter++;
         srv = 'https://gispub.epa.gov/arcgis/rest/services/OW/ATTAINS_Assessment/MapServer/2/query'; 
         var data = {
             "where":                "assessmentunitidentifier = '" + lazy_auid + "'"
            ,"outfields":            "assessmentunitidentifier,reportingcycle,waterbodyreportlink"
            ,"returnGeometry":       "true"
            ,"returnIdsOnly":        "false"
            ,"returnCountOnly":      "false"
            ,"returnDistinctValues": "false"
            ,"orderByFields":        "assessmentunitidentifier"
            ,"f":                    "geojson"
         };
           
         L.esri.get(
             srv
            ,data
            ,select_ass_resp1
         );
         
      } else {
         document.getElementById("dzATTAINSAreas").value = "";
         
      }
      
      if ( lcnt > 0 ) {
         waiter++;
         srv = 'https://gispub.epa.gov/arcgis/rest/services/OW/ATTAINS_Assessment/MapServer/1/query';
         var data = {
             "where":                "assessmentunitidentifier = '" + lazy_auid + "'"
            ,"outfields":            "assessmentunitidentifier,reportingcycle,waterbodyreportlink"
            ,"returnGeometry":       "true"
            ,"returnIdsOnly":        "false"
            ,"returnCountOnly":      "false"
            ,"returnDistinctValues": "false"
            ,"orderByFields":        "assessmentunitidentifier"
            ,"f":                    "geojson"
         };
           
         L.esri.get(
             srv
            ,data
            ,select_ass_resp2
         );
         
      } else {
         document.getElementById("dzATTAINSLines").value = "";
         
      }
      
      if ( pcnt > 0 ) {
         waiter++;
         srv = 'https://gispub.epa.gov/arcgis/rest/services/OW/ATTAINS_Assessment/MapServer/0/query';
         var data = {
             "where":                "assessmentunitidentifier = '" + lazy_auid + "'"
            ,"outfields":            "assessmentunitidentifier,reportingcycle,waterbodyreportlink"
            ,"returnGeometry":       "true"
            ,"returnIdsOnly":        "false"
            ,"returnCountOnly":      "false"
            ,"returnDistinctValues": "false"
            ,"orderByFields":        "assessmentunitidentifier"
            ,"f":                    "geojson"
         };
           
         L.esri.get(
             srv
            ,data
            ,select_ass_resp3
         );
         
      } else {
         document.getElementById("dzATTAINSPoints").value = "";
         
      }
      
      srv = 'https://gispub.epa.gov/arcgis/rest/services/OW/ATTAINS_Assessment/MapServer/3/query';
      var data = {
          "where":                "assessmentunitidentifier = '" + lazy_auid + "'"
         ,"outfields":            "catchmentstatecode,nhdplusid,areasqkm"
         ,"returnGeometry":       "true"
         ,"returnIdsOnly":        "false"
         ,"returnCountOnly":      "false"
         ,"returnDistinctValues": "false"
         ,"orderByFields":        "catchmentstatecode,nhdplusid"
         ,"f":                    "geojson"
      };
        
      L.esri.get(
          srv
         ,data
         ,select_cat_resp
      );
      
   }
   
   function select_ass_resp1(error,response) {
      
      if (error) {
         document.getElementById("output").innerHTML = "<P>" + error + "</P>";
         busy_off();
         return false;
      }
      
      ATTAINS_areas.addData(response).setStyle({
          "color":       "#33CC33"
         ,"fillColor":   "#33CC33"
         ,"fillOpacity": .50
      });
      document.getElementById("dzATTAINSAreas").value = JSON.stringify(response);
      waiter--;
         
   }
   
   function select_ass_resp2(error,response) {
      
      if (error) {
         document.getElementById("output").innerHTML = "<P>" + error + "</P>";
         busy_off();
         return false;
      }
      
      ATTAINS_lines.addData(response).setStyle({
          "color":       "#33CC33"
         ,"fillColor":   "#33CC33"
         ,"fillOpacity": .50
      });
      document.getElementById("dzATTAINSLines").value = JSON.stringify(response);
      waiter--;
      
   }
   
   function select_ass_resp3(error,response) {
      
      if (error) {
         document.getElementById("output").innerHTML = "<P>" + error + "</P>";
         busy_off();
         return false;
      }
      
      ATTAINS_points.addData(response).setStyle({
          "color":       "#33CC33"
         ,"fillColor":   "#33CC33"
         ,"fillOpacity": .50
      });
      document.getElementById("dzATTAINSPoints").value = JSON.stringify(response);
      waiter--;
      
   }
   
   async function select_cat_resp(error,response) {
      
      if (error) {
         document.getElementById("output").innerHTML = "<P>" + error + "</P>";
         busy_off();
         return false;
      }

      ATTAINS_catchments.addData(response).setStyle({
          "color":        "#66FFFF"
         ,"fillColor":    "#66FFFF"
         ,"fillOpacity":  0.3
      });
      
      tbody = document.getElementById('dzATTAINSCats').getElementsByTagName('tbody')[0];
      tbody.innerHTML = "";
      cell_style = "font-family: Arial; font-size: 12px; padding: 5px;";
      
      meas = 0;
      for (var i = 0; i < response.features.length; i++) {
         meas += response.features[i].properties.areasqkm;
         
         row   = tbody.insertRow(i);
         
         cell1 = row.insertCell(0);
         cell2 = row.insertCell(1);
         cell3 = row.insertCell(2);
         cell4 = row.insertCell(3);
         cell5 = row.insertCell(4);
         
         cell1.style = cell_style;
         cell2.style = cell_style;
         cell3.style = cell_style;
         cell4.style = cell_style;
         cell5.style = cell_style;
         
         cell1.innerHTML = i + 1;
         cell2.innerHTML = response.features[i].properties.catchmentstatecode;
         cell3.innerHTML = response.features[i].properties.nhdplusid;
         cell4.innerHTML = roundNumber(response.features[i].properties.areasqkm,4);
         cell5.innerHTML = roundNumber(response.features[i].properties.tribal_areasqkm,4);
         
      }
      document.getElementById("dzMeas").value = meas.toFixed(3);
      document.getElementById("dzCatCount").value = response.features.length;
      
      if ( waiter > 1 ) {
         await new Promise(r => setTimeout(r,50));
         if ( waiter > 1 ) {
            await new Promise(r => setTimeout(r,50));
            if ( waiter > 1 ) {
               await new Promise(r => setTimeout(r,100));
               if ( waiter > 1 ) {
                  await new Promise(r => setTimeout(r,100));
                  if ( waiter > 1 ) {
                     await new Promise(r => setTimeout(r,200));
                     if ( waiter > 1 ) {
                        await new Promise(r => setTimeout(r,200));
                     }
                  }
               }
            }
         }
      }
      
      if (ATTAINS_catchments.getLayers().length > 0) {
         map.fitBounds(ATTAINS_catchments.getBounds(), {
            maxZoom: 16
         });
         
      } else if (ATTAINS_areas.getLayers().length > 0) {
         map.fitBounds(ATTAINS_areas.getBounds(), {
            maxZoom: 16
         });
         
      } else if (ATTAINS_lines.getLayers().length > 0) {
         map.fitBounds(ATTAINS_lines.getBounds(), {
            maxZoom: 16
         });
         
      } else if (ATTAINS_points.getLayers().length > 0) {
         map.fitBounds(ATTAINS_points.getBounds(), {
            maxZoom: 16
         });
         
      } 
      
      busy_off();
      
   }
   
   function select_off(val) {
      busy_on();
      
      var roff = document.getElementById("dzAssessmentOffset");
      
      var data = {
          "where":                "organizationid = '" + lazy_org + "' and (point_count > 0 or line_count > 0 or area_count > 0)"
         ,"outfields":            "assessmentunitidentifier,reportingcycle,point_count,line_count,area_count"
         ,"returnGeometry":       "false"
         ,"returnIdsOnly":        "false"
         ,"returnCountOnly":      "false"
         ,"returnDistinctValues": "false"
         ,"orderByFields":        "assessmentunitidentifier"
         ,"resultOffset":         val
      };

      L.esri.get(
          'https://gispub.epa.gov/arcgis/rest/services/OW/ATTAINS_Assessment/MapServer/4/query'
         ,data
         ,select_org_resp
      );
      
   }
   
   function select_toggle() {
   
      if (
         document.getElementById("dzATTAINSPoints").style.display == 'none') {
         document.getElementById("dzATTAINSPoints").style.display = 'block';
         document.getElementById("dzATTAINSLines").style.display  = 'block';
         document.getElementById("dzATTAINSAreas").style.display  = 'block';
         document.getElementById("dzATTAINSCats").style.display   = 'block';
         
      } else {
         document.getElementById("dzATTAINSPoints").style.display = 'none';
         document.getElementById("dzATTAINSLines").style.display  = 'none';
         document.getElementById("dzATTAINSAreas").style.display  = 'none';
         document.getElementById("dzATTAINSCats").style.display   = 'none';
         
      }
   
   }
   
   function select_back() {
      cnt = document.getElementById("dzCount").value;
      if (cnt == '' || cnt == '0') {
         return true;
      }
      
      var drp = document.getElementById("dzATTAINSAssessment");
      var sel = drp.selectedIndex;

      sel--;

      if (sel <= 0) {
         sel = drp.options.length - 1;
      }

      drp.selectedIndex = sel;
      select_ass(drp.value);
      
   }
   
   function select_forward() {
      var cnt = document.getElementById("dzCount").value;
      if (cnt == '' || cnt == '0') {
         return true;
      }
      
      var drp = document.getElementById("dzATTAINSAssessment");
      var sel = drp.selectedIndex;

      sel++;

      if (sel >= drp.options.length) {
         sel = 0;
      }

      drp.selectedIndex = sel;
      select_ass(drp.value);
      
   }

   function get_url_parameter(param_key) {
      var page_url = window.location.search.substring(1);
      
      var url_variables = page_url.split('&');
      for (var i = 0; i < url_variables.length; i++) {
         var parameter_name = url_variables[i].split('=');
         if (parameter_name[0] == param_key) {
            return parameter_name[1];
         }
      }
      return null;
   }
   
   function roundNumber(number, digits) {
      if (number === null || number === undefined ) {
         return null;
      }
      var multiple = Math.pow(10, digits);
      var rndedNum = Math.round(number * multiple) / multiple;
      return rndedNum;
   }

   function httpPost(url,data,callback) {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open("POST",url,true);
      xmlHttp.setRequestHeader('Content-Type','application/json');
      xmlHttp.responseType = 'json';
      xmlHttp.onreadystatechange = function() {
         if(xmlHttp.readyState === 4) {
            if(xmlHttp.status === 200) {
               response = xmlHttp.response;
               callback(null,response);
            } else {
               callback(xmlHttp.statusText,null);
            }
         }
      };
      xmlHttp.send(JSON.stringify(data));
   }
  
  function build_api() {
      
      if (
         typeof postgrest_host === "undefined" ||
         postgrest_host === null ||
         postgrest_host == "NONE"
      ) {
         zpostgrest_host = get_url_parameter("postgrest_host");
      } else {
         zpostgrest_host = postgrest_host;
      }

      if (
         typeof postgrest_port === "undefined" ||
         postgrest_port === null ||
         postgrest_port == "NONE"
      ) {
         zpostgrest_port = get_url_parameter("postgrest_port");
      } else {
         zpostgrest_port = postgrest_port;
      }

      if (
         typeof postgrest_pref === "undefined" ||
         postgrest_pref === null ||
         postgrest_pref == "NONE"
      ) {
         zpostgrest_pref = get_url_parameter("postgrest_pref");
      } else {
         zpostgrest_pref = postgrest_pref;
      }
      
      if (zpostgrest_pref === null ) {
         zpostgrest_pref = "";
      } else {
         zpostgrest_pref = zpostgrest_pref + "/";
      }

      if (zpostgrest_host === null) {
         console.log("no PostgREST API server location defined.");
         return;
      }

      var http = "http";
      if (zpostgrest_port == "443") {
         http = "https";
      }
      
      return http +
         "://" +
         zpostgrest_host +
         ":" +
         zpostgrest_port + "/" + 
         zpostgrest_pref + "rpc/";
         
   }
                
      </script>
   </body>
</html>
